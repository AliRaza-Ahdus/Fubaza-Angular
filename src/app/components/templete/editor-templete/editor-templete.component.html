<div class="template-editor-container">
  <!-- Mobile Navigation Buttons (Visible only on small screens) -->
  <div class="mobile-nav-buttons">
    <button [ngClass]="{'active': activeMobilePanel === 'sidebar'}" (click)="toggleMobilePanel('sidebar')">
      <mat-icon>dashboard</mat-icon>
      <span>Elements</span>
    </button>
    <button [ngClass]="{'active': activeMobilePanel === 'canvas'}" (click)="toggleMobilePanel('canvas')">
      <mat-icon>brush</mat-icon>
      <span>Canvas</span>
    </button>
    <button [ngClass]="{'active': activeMobilePanel === 'properties'}" (click)="toggleMobilePanel('properties')" [disabled]="selectedElement === null">
      <mat-icon>tune</mat-icon>
      <span>Properties</span>
    </button>
  </div>

  <div class="template-editor-header">
    <div class="header-left">
      <div class="app-logo">
        <mat-icon>design_services</mat-icon>
        <h2 class="template-editor-title">Template Studio</h2>
      </div>
      <div class="template-info">
        <input type="text" class="template-name-input" [(ngModel)]="template.name" placeholder="Untitled Template">
        <select class="template-type-select" [(ngModel)]="template.type">
          <option value="">Select type</option>
          <option *ngFor="let type of templateTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>
    </div>
    <div class="header-actions">
      <div class="history-controls">
        <button class="history-btn" [disabled]="!canUndo" (click)="undo()" title="Undo">
          <mat-icon>undo</mat-icon>
        </button>
        <button class="history-btn" [disabled]="!canRedo" (click)="redo()" title="Redo">
          <mat-icon>redo</mat-icon>
        </button>
      </div>
      <button class="preview-btn" title="Preview" (click)="previewTemplate()">
        <mat-icon>visibility</mat-icon>
      </button>
      <div class="export-btn-wrapper">
        <button class="export-btn" (click)="toggleExportOptions()">
          <mat-icon>download</mat-icon>
          <span>Export</span>
        </button>
        <div class="export-options" *ngIf="showExportOptions">
          <button (click)="exportTemplate('png', 'standard')">PNG (Standard)</button>
          <button (click)="exportTemplate('png', 'high')">PNG (High-Res)</button>
          <button (click)="exportTemplate('jpg', 'standard')">JPG (Standard)</button>
          <button (click)="exportTemplate('jpg', 'high')">JPG (High-Res)</button>
          <button (click)="exportTemplate('pdf', 'standard')">PDF</button>
          <button (click)="generateShareLink()">Share Link</button>
        </div>
      </div>
      <button class="save-btn" (click)="saveTemplateWithImageConversion()">
        <mat-icon>save</mat-icon>
        <span>Save</span>
      </button>
      <button class="exit-btn" (click)="cancelEdit()">Exit</button>
    </div>
  </div>
  
  <div class="template-editor-main">
    <div class="template-sidebar" [ngClass]="{'mobile-active': activeMobilePanel === 'sidebar'}">
      <div class="sidebar-section">
        <h3 class="sidebar-title">Text Elements</h3>
        <div class="text-elements-grid">
          <div class="text-element-item" (click)="addTextElement('heading')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'heading'})" (dragend)="onDragEnd()">
            <mat-icon>format_h1</mat-icon>
            <div class="element-preview">
              <span class="preview-text heading-preview">Heading</span>
            </div>
          </div>
          <div class="text-element-item" (click)="addTextElement('subheading')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'subheading'})" (dragend)="onDragEnd()">
            <mat-icon>format_h2</mat-icon>
            <div class="element-preview">
              <span class="preview-text subheading-preview">Subheading</span>
            </div>
          </div>
          <div class="text-element-item" (click)="addTextElement('body')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'body'})" (dragend)="onDragEnd()">
            <mat-icon>article</mat-icon>
            <div class="element-preview">
              <span class="preview-text body-preview">Body Text</span>
            </div>
          </div>
          <div class="text-element-item" (click)="addTextElement('caption')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'caption'})" (dragend)="onDragEnd()">
            <mat-icon>text_fields_alt</mat-icon>
            <div class="element-preview">
              <span class="preview-text caption-preview">Caption</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3 class="sidebar-title">Media & Shapes</h3>
        <div class="elements-list">
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'image')" (dragend)="onDragEnd()">
            <mat-icon>photo</mat-icon>
            <span>Image</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'shape')" (dragend)="onDragEnd()" (click)="openShapeSelector()">
            <mat-icon>shapes</mat-icon>
            <span>Shape</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'line')" (dragend)="onDragEnd()">
            <mat-icon>show_chart</mat-icon>
            <span>Line</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'icon')" (dragend)="onDragEnd()">
            <mat-icon>star</mat-icon>
            <span>Icon</span>
          </div>
        </div>
        
        <!-- Shape Selector Expanded Panel -->
        <div class="shapes-panel" *ngIf="showShapeSelector">
          <h3 class="shapes-title">Select Shape</h3>
          
          <!-- Basic Shapes -->
          <div class="shape-category">
            <h4 class="shape-category-title">Basic Shapes</h4>
            <div class="shapes-grid">
              <div class="shape-option" (click)="addShapeToCanvas('rectangle')">
                <div class="shape-preview rectangle"></div>
                <span>Rectangle</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('circle')">
                <div class="shape-preview circle"></div>
                <span>Circle</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('ellipse')">
                <div class="shape-preview ellipse"></div>
                <span>Ellipse</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('square')">
                <div class="shape-preview square"></div>
                <span>Square</span>
              </div>
            </div>
          </div>
          
          <!-- Geometric Shapes -->
          <div class="shape-category">
            <h4 class="shape-category-title">Geometric</h4>
            <div class="shapes-grid">
              <div class="shape-option" (click)="addShapeToCanvas('triangle')">
                <div class="shape-preview triangle"></div>
                <span>Triangle</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('diamond')">
                <div class="shape-preview diamond"></div>
                <span>Diamond</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('hexagon')">
                <div class="shape-preview hexagon"></div>
                <span>Hexagon</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('octagon')">
                <div class="shape-preview octagon"></div>
                <span>Octagon</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('pentagon')">
                <div class="shape-preview pentagon"></div>
                <span>Pentagon</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('star')">
                <div class="shape-preview star"></div>
                <span>Star</span>
              </div>
            </div>
          </div>
          
          <!-- Lines & Arrows -->
          <div class="shape-category">
            <h4 class="shape-category-title">Lines & Arrows</h4>
            <div class="shapes-grid">
              <div class="shape-option" (click)="addShapeToCanvas('line')">
                <div class="shape-preview line"></div>
                <span>Line</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('arrow-right')">
                <div class="shape-preview arrow-right"></div>
                <span>Arrow</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('arrow-left')">
                <div class="shape-preview arrow-left"></div>
                <span>Left Arrow</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('arrow-up')">
                <div class="shape-preview arrow-up"></div>
                <span>Up Arrow</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('arrow-down')">
                <div class="shape-preview arrow-down"></div>
                <span>Down Arrow</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('double-arrow')">
                <div class="shape-preview double-arrow"></div>
                <span>Double Arrow</span>
              </div>
            </div>
          </div>
          
          <!-- Special Shapes -->
          <div class="shape-category">
            <h4 class="shape-category-title">Special</h4>
            <div class="shapes-grid">
              <div class="shape-option" (click)="addShapeToCanvas('heart')">
                <div class="shape-preview heart"></div>
                <span>Heart</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('speech-bubble')">
                <div class="shape-preview speech-bubble"></div>
                <span>Speech Bubble</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('burst')">
                <div class="shape-preview burst"></div>
                <span>Burst</span>
              </div>
              <div class="shape-option" (click)="addShapeToCanvas('cloud')">
                <div class="shape-preview cloud"></div>
                <span>Cloud</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3 class="sidebar-title">Canvas Presets</h3>
        <div class="canvas-presets">
          <!-- Fixed Canvas Presets -->
          <div class="preset-group">
            <h4 class="preset-group-title">Standard Sizes</h4>
            <div class="preset-buttons">
              <button class="preset-btn" (click)="setCanvasSize('square')">
                <span class="preset-name">Square</span>
                <span class="preset-dimensions">1080×1080</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('portrait')">
                <span class="preset-name">Portrait</span>
                <span class="preset-dimensions">1080×1920</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('landscape')">
                <span class="preset-name">Landscape</span>
                <span class="preset-dimensions">1920×1080</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('custom')">
                <span class="preset-name">Custom</span>
                <span class="preset-dimensions">{{canvasWidth}}×{{canvasHeight}}</span>
              </button>
            </div>
          </div>
          
          <!-- Social Media Presets -->
          <div class="preset-group">
            <h4 class="preset-group-title">Social Media</h4>
            <div class="preset-buttons">
              <button class="preset-btn" (click)="setCanvasSize('instagram')">
                <span class="preset-name">Instagram Post</span>
                <span class="preset-dimensions">1080×1080</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('story')">
                <span class="preset-name">Instagram Story</span>
                <span class="preset-dimensions">1080×1920</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('facebook')">
                <span class="preset-name">Facebook Post</span>
                <span class="preset-dimensions">1200×630</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('twitter')">
                <span class="preset-name">Twitter Post</span>
                <span class="preset-dimensions">1200×675</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('youtube')">
                <span class="preset-name">YouTube Thumbnail</span>
                <span class="preset-dimensions">1280×720</span>
              </button>
              <button class="preset-btn" (click)="setCanvasSize('linkedin')">
                <span class="preset-name">LinkedIn Post</span>
                <span class="preset-dimensions">1200×627</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Color Palette Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">Color Palette</h3>
        <div class="color-palette-container">
          <div class="palette-tabs">
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'saved'}" (click)="activePaletteTab = 'saved'">Saved</button>
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'recent'}" (click)="activePaletteTab = 'recent'">Recent</button>
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'brand'}" (click)="activePaletteTab = 'brand'">Brand</button>
          </div>
          
          <!-- Saved Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'saved'">
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of savedColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   (contextmenu)="removeColor(color, $event)"
                   [title]="color">
              </div>
              <div class="add-color-swatch" (click)="openColorPicker()">
                <mat-icon>add</mat-icon>
              </div>
            </div>
          </div>
          
          <!-- Recent Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'recent'">
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of recentColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   [title]="color">
              </div>
            </div>
          </div>
          
          <!-- Brand Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'brand'">
            <div class="brand-palette-controls">
              <button class="brand-btn" (click)="saveBrandPalette()">Save Current as Brand</button>
              <button class="brand-btn" (click)="loadBrandPalette()">Load Brand Palette</button>
            </div>
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of brandColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   [title]="color">
              </div>
            </div>
          </div>
          
          <!-- Color Picker -->
          <div class="advanced-color-picker" *ngIf="showColorPicker">
            <div class="color-picker-header">
              <h4>Color Picker</h4>
              <button class="close-picker" (click)="closeColorPicker()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div class="color-picker-content">
              <input type="color" [(ngModel)]="pickerColor" (change)="updatePickerColor()">
              <div class="color-inputs">
                <div class="color-input-group">
                  <label>HEX</label>
                  <input type="text" [(ngModel)]="hexColor" (change)="updateFromHex()">
                </div>
                <div class="color-input-group">
                  <label>RGB</label>
                  <div class="rgb-inputs">
                    <input type="number" [(ngModel)]="rgbColor.r" (change)="updateFromRGB()" min="0" max="255">
                    <input type="number" [(ngModel)]="rgbColor.g" (change)="updateFromRGB()" min="0" max="255">
                    <input type="number" [(ngModel)]="rgbColor.b" (change)="updateFromRGB()" min="0" max="255">
                  </div>
                </div>
              </div>
              <div class="opacity-control">
                <label>Opacity: {{colorOpacity || 1}}</label>
                <input type="range" [(ngModel)]="colorOpacity" min="0" max="1" step="0.1">
              </div>
              <button class="add-to-palette-btn" (click)="addToPalette()">Add to Palette</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Canvas Background Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">Canvas Background</h3>
        <div class="background-controls">
          <div class="background-type-selector">
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'color'}"
                    (click)="setBackgroundType('color')">
              <mat-icon>palette</mat-icon>
              <span>Color</span>
            </button>
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'gradient'}"
                    (click)="setBackgroundType('gradient')">
              <mat-icon>gradient</mat-icon>
              <span>Gradient</span>
            </button>
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'image'}"
                    (click)="setBackgroundType('image')">
              <mat-icon>image</mat-icon>
              <span>Image</span>
            </button>
          </div>
          
          <!-- Solid Color Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'color'">
            <div class="color-picker-group">
              <label>Background Color</label>
              <input type="color" [(ngModel)]="canvasBackground.color" (change)="updateCanvasBackground()">
            </div>
          </div>
          
          <!-- Gradient Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'gradient'">
            <div class="gradient-controls">
              <div class="gradient-type">
                <label>Gradient Type</label>
                <select [(ngModel)]="canvasBackground.gradientType" (change)="updateCanvasBackground()">
                  <option value="linear">Linear</option>
                  <option value="radial">Radial</option>
                </select>
              </div>
              <div class="gradient-colors">
                <div class="color-stop">
                  <label>Color 1</label>
                  <input type="color" [(ngModel)]="canvasBackground.gradientColor1" (change)="updateCanvasBackground()">
                </div>
                <div class="color-stop">
                  <label>Color 2</label>
                  <input type="color" [(ngModel)]="canvasBackground.gradientColor2" (change)="updateCanvasBackground()">
                </div>
              </div>
              <div class="gradient-angle" *ngIf="canvasBackground.gradientType === 'linear'">
                <label>Angle: {{canvasBackground.gradientAngle || 45}}°</label>
                <input type="range" [(ngModel)]="canvasBackground.gradientAngle" 
                       (change)="updateCanvasBackground()" min="0" max="360" step="15">
              </div>
            </div>
          </div>
          
          <!-- Image Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'image'">
            <div class="image-bg-controls">
              <button class="upload-bg-btn" (click)="triggerBackgroundUpload()">
                <mat-icon>cloud_upload</mat-icon>
                <span>Upload Background</span>
              </button>
              <input type="file" #backgroundUpload style="display: none" 
                     (change)="onBackgroundSelected($event)" accept="image/*">
              
              <div class="bg-image-preview" *ngIf="canvasBackground.imageUrl">
                <img [src]="canvasBackground.imageUrl" alt="Background">
                <button class="remove-bg-btn" (click)="removeBackgroundImage()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              
              <div class="bg-image-options" *ngIf="canvasBackground.imageUrl">
                <div class="bg-option">
                  <label>Opacity: {{canvasBackground.opacity || 1}}</label>
                  <input type="range" [(ngModel)]="canvasBackground.opacity" 
                         (change)="updateCanvasBackground()" min="0.1" max="1" step="0.1">
                </div>
                <div class="bg-option">
                  <label>Blur: {{canvasBackground.blur || 0}}px</label>
                  <input type="range" [(ngModel)]="canvasBackground.blur" 
                         (change)="updateCanvasBackground()" min="0" max="10" step="1">
                </div>
                <div class="bg-option">
                  <label>Overlay Color</label>
                  <input type="color" [(ngModel)]="canvasBackground.overlayColor" 
                         (change)="updateCanvasBackground()">
                </div>
                <div class="bg-option">
                  <label>Overlay Opacity: {{canvasBackground.overlayOpacity || 0}}</label>
                  <input type="range" [(ngModel)]="canvasBackground.overlayOpacity" 
                         (change)="updateCanvasBackground()" min="0" max="1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3 class="sidebar-title">Media</h3>
        <div class="upload-options">
          <div class="upload-method">
            <button class="upload-btn" (click)="triggerUpload()">
              <mat-icon>cloud_upload</mat-icon>
              <span>Upload Image</span>
            </button>
            <input type="file" #fileUpload style="display: none" (change)="onFileSelected($event)" accept="image/*">
          </div>
        </div>
        
        <div class="uploads-list" *ngIf="uploads.length > 0">
          <div class="upload-item" *ngFor="let upload of uploads" (click)="addElementToCanvas('image', upload)">
            <img [src]="upload.url" [alt]="upload.name">
            <button class="delete-upload-btn" (click)="deleteUpload(upload.id, $event)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="canvas-container" [ngClass]="{'mobile-active': activeMobilePanel === 'canvas'}">
      <div class="canvas-toolbar">
        <div class="toolbar-section">
          <div class="canvas-info">
            <span class="canvas-dimensions">{{canvasWidth}} x {{canvasHeight}} px</span>
            <button class="tool-btn" (click)="openCustomSizeDialog()" title="Change Canvas Size">
              <mat-icon>photo_size_select_large</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="canvas-tools">
            <button class="tool-btn" [ngClass]="{'active': showGrid}" (click)="toggleGrid()" title="Toggle Grid">
              <mat-icon>grid_4x4</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': snapToGrid}" (click)="toggleSnapToGrid()" title="Snap to Grid">
              <mat-icon>grid_goldenratio</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': showAlignmentGuides}" (click)="toggleAlignmentGuides()" title="Alignment Guides">
              <mat-icon>align_horizontal_center</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': showRulers}" (click)="toggleRulers()" title="Rulers">
              <mat-icon>straighten</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="view-controls">
            <button class="view-btn" (click)="fitToScreen()" title="Fit to Screen">
              <mat-icon>fit_screen</mat-icon>
            </button>
            <button class="view-btn" (click)="actualSize()" title="Actual Size (100%)">
              <mat-icon>aspect_ratio</mat-icon>
            </button>
            <button class="view-btn" (click)="centerCanvas()" title="Center Canvas">
              <mat-icon>center_focus_strong</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="zoom-controls">
            <button class="zoom-btn" (click)="setZoom(25)" title="25%">25%</button>
            <button class="zoom-btn" (click)="setZoom(50)" title="50%">50%</button>
            <button class="zoom-btn" (click)="zoom(-10)" title="Zoom Out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <span class="zoom-level">{{ zoomLevel }}%</span>
            <button class="zoom-btn" (click)="zoom(10)" title="Zoom In">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button class="zoom-btn" (click)="setZoom(100)" title="100%">100%</button>
            <button class="zoom-btn" (click)="setZoom(200)" title="200%">200%</button>
          </div>
        </div>
      </div>
      
      <div class="canvas-workspace" 
           [style.transform]="'scale(' + zoomLevel/100 + ') translate(' + panX + 'px, ' + panY + 'px)'" 
           [style.transform-origin]="'center center'"
           (drop)="onDrop($event)" 
           (dragover)="onDragOver($event)"
           (mousedown)="startPan($event)"
           (wheel)="onWheel($event)">
           
        <!-- Rulers -->
        <div class="rulers" *ngIf="showRulers">
          <div class="ruler horizontal-ruler"></div>
          <div class="ruler vertical-ruler"></div>
        </div>
        
        <div class="canvas" #canvas 
             [style.width.px]="canvasWidth" 
             [style.height.px]="canvasHeight" 
             [ngClass]="{'show-grid': showGrid}"
             [style.background]="getCanvasBackgroundStyle()">
             
          <!-- Grid overlay for snap-to-grid -->
          <div class="grid-overlay" *ngIf="showGrid"
               [style.background-size]="gridSize + 'px ' + gridSize + 'px'"></div>
          
          <!-- Alignment guides -->
          <div class="alignment-guides" *ngIf="showAlignmentGuides && selectedElement !== null">
            <div class="guide horizontal-center" *ngIf="showHorizontalCenterGuide"></div>
            <div class="guide vertical-center" *ngIf="showVerticalCenterGuide"></div>
            <div class="guide left-edge" *ngIf="showLeftEdgeGuide"></div>
            <div class="guide right-edge" *ngIf="showRightEdgeGuide"></div>
            <div class="guide top-edge" *ngIf="showTopEdgeGuide"></div>
            <div class="guide bottom-edge" *ngIf="showBottomEdgeGuide"></div>
          </div>
          <!-- Canvas elements will be rendered here -->
          <div *ngFor="let element of canvasElements; let i = index" 
               class="canvas-element" 
               [ngClass]="{'selected': selectedElement === i, 'locked': element.locked, 'hidden': element.hidden}" 
               [style.left.px]="element.x" 
               [style.top.px]="element.y"
               [style.width.px]="element.width"
               [style.height.px]="element.height"
               [style.z-index]="i + 1"
               [style.transform]="getElementTransform(element)"
               [style.opacity]="element.hidden ? 0 : (element.opacity || 1)"
               [style.pointer-events]="element.locked ? 'none' : 'auto'"
               [style.mix-blend-mode]="element.blendMode || 'normal'"
               (mousedown)="selectElement(i, $event)">
            
            <!-- Text element -->
            <div *ngIf="element.type === 'text'" 
                 class="text-element" 
                 [style.fontSize.px]="element.fontSize"
                 [style.color]="getTextColor(element)"
                 [style.background]="getTextGradient(element)"
                 [style.webkitBackgroundClip]="element.textGradientType && element.textGradientType !== 'none' ? 'text' : 'unset'"
                 [style.webkitTextFillColor]="element.textGradientType && element.textGradientType !== 'none' ? 'transparent' : 'unset'"
                 [style.fontFamily]="element.fontFamily"
                 [style.fontWeight]="element.fontWeight"
                 [style.fontStyle]="element.fontStyle"
                 [style.textDecoration]="element.textDecoration"
                 [style.textAlign]="element.textAlign"
                 [style.backgroundColor]="getTextBackgroundColor(element)"
                 [style.padding.px]="element.padding"
                 [style.borderRadius.px]="element.borderRadius"
                 [style.lineHeight]="element.lineHeight"
                 [style.letterSpacing.px]="element.letterSpacing"
                 [style.textTransform]="element.textTransform"
                 [style.webkitTextStrokeWidth.px]="element.textStrokeWidth"
                 [style.webkitTextStrokeColor]="element.textStrokeColor"
                 [style.textShadow]="element.textShadow"
                 [style.transform]="getTextTransform(element)"
                 [style.opacity]="element.opacity || 1"
                 [contentEditable]="selectedElement === i"
                 (blur)="updateElementContent(i, $event)"
                 (focus)="selectedElement = i">
              {{ element.content }}
            </div>
            
            <!-- Image element -->
            <img *ngIf="element.type === 'image'" 
                 [src]="element.src" 
                 [alt]="element.alt || 'Image'" 
                 class="image-element"
                 [style.objectFit]="element.objectFit || 'contain'"
                 [style.objectPosition]="element.objectPosition || 'center'"
                 [style.borderRadius.px]="element.borderRadius"
                 [style.border]="element.border"
                 [style.boxShadow]="element.boxShadow"
                 [style.filter]="getImageFilter(element)"
                 [style.opacity]="element.opacity || 1"
                 [style.clipPath]="getImageMask(element)">
            
            <!-- Shape element -->
            <div *ngIf="element.type === 'shape'" 
                 class="shape-element"
                 [style.background]="getShapeBackground(element)"
                 [style.borderRadius.px]="getShapeBorderRadius(element)"
                 [style.clipPath]="getShapeClipPath(element)"
                 [style.boxShadow]="element.boxShadow"
                 [style.opacity]="element.opacity || 1"
                 [style.border]="element.border">
            </div>

            <!-- Line element -->
            <div *ngIf="element.type === 'line'" 
                 class="line-element"
                 [style.backgroundColor]="element.color"
                 [style.height.px]="element.lineWidth || 2"
                 [style.opacity]="element.opacity || 1">
            </div>

            <!-- Icon element -->
            <div *ngIf="element.type === 'icon'" 
                 class="icon-element"
                 [style.backgroundImage]="'url(' + element.src + ')'"
                 [style.backgroundSize]="'contain'"
                 [style.backgroundRepeat]="'no-repeat'"
                 [style.backgroundPosition]="'center'"
                 [style.filter]="getIconFilter(element)"
                 [style.opacity]="element.opacity || 1">
            </div>
            
            <!-- Resize handles (only show for selected element) -->
            <div *ngIf="selectedElement === i" class="resize-handles">
              <div class="resize-handle top-left" (mousedown)="startResize(i, 'top-left', $event)"></div>
              <div class="resize-handle top-right" (mousedown)="startResize(i, 'top-right', $event)"></div>
              <div class="resize-handle bottom-left" (mousedown)="startResize(i, 'bottom-left', $event)"></div>
              <div class="resize-handle bottom-right" (mousedown)="startResize(i, 'bottom-right', $event)"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="properties-panel" [ngClass]="{'mobile-active': activeMobilePanel === 'properties'}">
      
      <!-- Layer Management Panel -->
      <div class="layer-management" *ngIf="canvasElements.length > 0">
        <div class="layer-header">
          <h3 class="panel-title">Layers</h3>
          <div class="layer-actions">
            <button class="layer-action-btn" title="Select All" (click)="selectAllElements()">
              <mat-icon>checklist</mat-icon>
            </button>
            <button class="layer-action-btn" title="Group Selected" (click)="groupSelectedElements()" 
                    [disabled]="selectedElements.length < 2">
              <mat-icon>group</mat-icon>
            </button>
            <button class="layer-action-btn" title="Ungroup Selected" (click)="ungroupSelectedElements()"
                    [disabled]="!hasGroupedElements()">
              <mat-icon>ungroup</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="layers-list">
          <div class="layer-item" 
               *ngFor="let element of canvasElements; let i = index; trackBy: trackByElementId"
               [ngClass]="{'selected': selectedElement === i || selectedElements.includes(i), 
                          'locked': element.locked, 
                          'hidden': element.hidden}"
               (click)="selectLayer(i, $event)"
               (dblclick)="startLayerRename(i)">
            
            <div class="layer-content">
              <div class="layer-icon">
                <mat-icon *ngIf="element.type === 'text'">text_fields</mat-icon>
                <mat-icon *ngIf="element.type === 'image'">photo</mat-icon>
                <mat-icon *ngIf="element.type === 'shape'">shapes</mat-icon>
                <mat-icon *ngIf="element.type === 'line'">show_chart</mat-icon>
              </div>
              
              <div class="layer-info">
                <span class="layer-name" *ngIf="!element.editing">
                  {{ element.layerName || getDefaultLayerName(element, i) }}
                </span>
                <input class="layer-name-input" 
                       *ngIf="element.editing"
                       [(ngModel)]="element.layerName" 
                       (blur)="finishLayerRename(i)"
                       (keydown.enter)="finishLayerRename(i)"
                       (keydown.escape)="cancelLayerRename(i)">
                <div class="layer-details">
                  <span class="layer-type">{{ element.type | titlecase }}</span>
                  <span class="layer-size">{{ element.width }}x{{ element.height }}</span>
                </div>
              </div>
            </div>
            
            <div class="layer-controls">
              <button class="layer-control-btn" 
                      [ngClass]="{'active': !element.hidden}"
                      (click)="toggleLayerVisibility(i, $event)" 
                      title="Toggle Visibility">
                <mat-icon>{{ element.hidden ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <button class="layer-control-btn" 
                      [ngClass]="{'active': element.locked}"
                      (click)="toggleLayerLock(i, $event)" 
                      title="Toggle Lock">
                <mat-icon>{{ element.locked ? 'lock' : 'lock_open' }}</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Element Properties (only show if element is selected) -->
      <div class="element-properties" *ngIf="selectedElement !== null">
        <h3 class="panel-title">Properties</h3>
        
        <div class="quick-actions">
          <button class="action-btn" title="Bring to Front" (click)="bringToFront()">
            <mat-icon>flip_to_front</mat-icon>
          </button>
          <button class="action-btn" title="Bring Forward" (click)="bringForward()">
            <mat-icon>keyboard_arrow_up</mat-icon>
          </button>
          <button class="action-btn" title="Send Backward" (click)="sendBackward()">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
          <button class="action-btn" title="Send to Back" (click)="sendToBack()">
            <mat-icon>flip_to_back</mat-icon>
          </button>
          <button class="action-btn" title="Duplicate" (click)="duplicateElement(selectedElement)">
            <mat-icon>content_copy</mat-icon>
          </button>
          <button class="action-btn" title="Reset Transform" (click)="resetElementTransform()">
            <mat-icon>refresh</mat-icon>
          </button>
          <button class="action-btn delete" title="Delete" (click)="deleteElement(selectedElement)">
            <mat-icon>delete_forever</mat-icon>
          </button>
        </div>
        
        <!-- Alignment Tools -->
        <div class="alignment-tools">
          <h4 class="tools-title">Alignment</h4>
          <div class="alignment-grid">
            <button class="align-btn" (click)="alignElement('left')" title="Align Left">
              <mat-icon>align_horizontal_left</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('center-horizontal')" title="Center Horizontal">
              <mat-icon>align_horizontal_center</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('right')" title="Align Right">
              <mat-icon>align_horizontal_right</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('top')" title="Align Top">
              <mat-icon>align_vertical_top</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('center-vertical')" title="Center Vertical">
              <mat-icon>align_vertical_center</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('bottom')" title="Align Bottom">
              <mat-icon>align_vertical_bottom</mat-icon>
            </button>
          </div>
          
          <div class="distribution-tools" *ngIf="selectedElements.length > 2">
            <button class="distribute-btn" (click)="distributeElements('horizontal')" title="Distribute Horizontally">
              <mat-icon>align_horizontal_left</mat-icon>
              <span>Horizontal</span>
            </button>
            <button class="distribute-btn" (click)="distributeElements('vertical')" title="Distribute Vertically">
              <mat-icon>align_vertical_top</mat-icon>
              <span>Vertical</span>
            </button>
          </div>
        </div>
      
      <!-- Common properties -->
      <div class="property-group">
        <label>Position & Size</label>
        <div class="property-grid">
          <div class="property-control">
            <span>X</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].x" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>Y</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].y" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>W</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].width" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>H</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].height" (change)="updateElement()">
          </div>
        </div>
      </div>
      
      <!-- Text specific properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'text'">
        <div class="property-group">
          <label>Text Content</label>
          <textarea [(ngModel)]="canvasElements[selectedElement].content" (change)="updateElement()" class="text-editor"></textarea>
        </div>
        
        <div class="property-group">
          <label>Font</label>
          <div class="text-formatting">
            <select [(ngModel)]="canvasElements[selectedElement].fontFamily" (change)="updateElement()" class="font-select">
              <option value="Arial">Arial</option>
              <option value="Helvetica">Helvetica</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Courier New">Courier New</option>
              <option value="Verdana">Verdana</option>
              <option value="Georgia">Georgia</option>
              <option value="Roboto">Roboto</option>
              <option value="Open Sans">Open Sans</option>
              <option value="Montserrat">Montserrat</option>
            </select>
            
            <div class="text-controls">
              <div class="font-size-control">
                <span>Size</span>
                <input type="number" [(ngModel)]="canvasElements[selectedElement].fontSize" (change)="updateElement()">
              </div>
              
              <div class="color-control">
                <span>Color</span>
                <input type="color" [(ngModel)]="canvasElements[selectedElement].color" (change)="updateElement()">
              </div>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Text Style</label>
          <div class="style-buttons">
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].fontWeight === 'bold'}" 
                    (click)="toggleTextStyle('fontWeight', 'bold')" title="Bold">
              <mat-icon>format_bold</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].fontStyle === 'italic'}" 
                    (click)="toggleTextStyle('fontStyle', 'italic')" title="Italic">
              <mat-icon>format_italic</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textDecoration === 'underline'}" 
                    (click)="toggleTextStyle('textDecoration', 'underline')" title="Underline">
              <mat-icon>format_underlined</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textTransform === 'uppercase'}" 
                    (click)="toggleTextStyle('textTransform', 'uppercase')" title="Uppercase">
              <mat-icon>text_rotation_none</mat-icon>
            </button>
          </div>
          <div class="alignment-buttons">
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textAlign === 'left'}" 
                    (click)="setTextStyle('textAlign', 'left')" title="Align Left">
              <mat-icon>format_align_left</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textAlign === 'center'}" 
                    (click)="setTextStyle('textAlign', 'center')" title="Align Center">
              <mat-icon>format_align_center</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textAlign === 'right'}" 
                    (click)="setTextStyle('textAlign', 'right')" title="Align Right">
              <mat-icon>format_align_right</mat-icon>
            </button>
            <button type="button" [ngClass]="{'active': canvasElements[selectedElement].textAlign === 'justify'}" 
                    (click)="setTextStyle('textAlign', 'justify')" title="Justify">
              <mat-icon>format_align_justify</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="property-group">
          <label>Font Settings</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Font Family</span>
              <select [(ngModel)]="canvasElements[selectedElement].fontFamily" (change)="updateElement()">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Times New Roman', serif">Times New Roman</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Courier New', monospace">Courier New</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Open Sans', sans-serif">Open Sans</option>
                <option value="'Playfair Display', serif">Playfair Display</option>
                <option value="'Montserrat', sans-serif">Montserrat</option>
              </select>
            </div>
            <div class="property-control">
              <span>Letter Spacing</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].letterSpacing" (change)="updateElement()" min="-2" max="10" step="0.5">
              <span class="value-display">{{ canvasElements[selectedElement].letterSpacing || 0 }}px</span>
            </div>
            <div class="property-control">
              <span>Line Height</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].lineHeight" (change)="updateElement()" min="0.8" max="3" step="0.1">
              <span class="value-display">{{ canvasElements[selectedElement].lineHeight || 1.2 }}</span>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Background & Spacing</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Background</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].backgroundColor" (change)="updateElement()">
            </div>
            <div class="property-control">
              <span>Padding (px)</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].padding" (change)="updateElement()" min="0" max="50">
            </div>
            <div class="property-control">
              <span>Border Radius</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].borderRadius" (change)="updateElement()" min="0" max="50">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Text Effects</label>
          <div class="text-effects-tabs">
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'stroke'}" (click)="activeTextEffectTab = 'stroke'">Stroke</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'shadow'}" (click)="activeTextEffectTab = 'shadow'">Shadow</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'gradient'}" (click)="activeTextEffectTab = 'gradient'">Gradient</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'highlight'}" (click)="activeTextEffectTab = 'highlight'">Highlight</button>
          </div>
          
          <!-- Stroke Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'stroke'">
            <div class="property-controls">
              <div class="property-control">
                <span>Stroke Width: {{canvasElements[selectedElement].textStrokeWidth || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].textStrokeWidth" 
                       (change)="updateElement()" min="0" max="5" step="0.5">
              </div>
              <div class="property-control">
                <span>Stroke Color</span>
                <input type="color" [(ngModel)]="canvasElements[selectedElement].textStrokeColor" (change)="updateElement()">
              </div>
            </div>
          </div>
          
          <!-- Shadow Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'shadow'">
            <div class="property-controls">
              <div class="property-control">
                <span>Shadow Preset</span>
                <select [(ngModel)]="canvasElements[selectedElement].textShadow" (change)="updateElement()">
                  <option value="none">None</option>
                  <option value="1px 1px 2px rgba(0,0,0,0.3)">Light</option>
                  <option value="2px 2px 4px rgba(0,0,0,0.4)">Medium</option>
                  <option value="3px 3px 5px rgba(0,0,0,0.5)">Heavy</option>
                  <option value="0px 0px 8px rgba(0,0,255,0.7)">Neon Blue</option>
                  <option value="0px 0px 8px rgba(255,0,0,0.7)">Neon Red</option>
                  <option value="0px 0px 3px white, 0px 0px 5px rgba(0,0,0,0.5)">Outline</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              
              <div class="custom-shadow-controls" *ngIf="canvasElements[selectedElement].textShadow === 'custom'">
                <div class="property-control">
                  <span>Shadow Color</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].customShadowColor" (change)="updateCustomTextShadow()">
                </div>
                <div class="property-control">
                  <span>Blur: {{canvasElements[selectedElement].customShadowBlur || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowBlur" 
                         (change)="updateCustomTextShadow()" min="0" max="20" step="1">
                </div>
                <div class="property-control">
                  <span>Offset X: {{canvasElements[selectedElement].customShadowX || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowX" 
                         (change)="updateCustomTextShadow()" min="-20" max="20" step="1">
                </div>
                <div class="property-control">
                  <span>Offset Y: {{canvasElements[selectedElement].customShadowY || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowY" 
                         (change)="updateCustomTextShadow()" min="-20" max="20" step="1">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Gradient Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'gradient'">
            <div class="property-controls">
              <div class="property-control">
                <span>Gradient Type</span>
                <select [(ngModel)]="canvasElements[selectedElement].textGradientType" (change)="updateTextGradient()">
                  <option value="none">None</option>
                  <option value="linear">Linear</option>
                  <option value="radial">Radial</option>
                </select>
              </div>
              
              <div class="gradient-controls" *ngIf="canvasElements[selectedElement].textGradientType !== 'none'">
                <div class="property-control">
                  <span>Color 1</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].textGradientColor1" (change)="updateTextGradient()">
                </div>
                <div class="property-control">
                  <span>Color 2</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].textGradientColor2" (change)="updateTextGradient()">
                </div>
                <div class="property-control" *ngIf="canvasElements[selectedElement].textGradientType === 'linear'">
                  <span>Angle: {{canvasElements[selectedElement].textGradientAngle || 45}}°</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].textGradientAngle" 
                         (change)="updateTextGradient()" min="0" max="360" step="15">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Highlight Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'highlight'">
            <div class="property-controls">
              <div class="property-control">
                <span>Highlight Style</span>
                <select [(ngModel)]="canvasElements[selectedElement].highlightStyle" (change)="updateElement()">
                  <option value="none">None</option>
                  <option value="solid">Solid Background</option>
                  <option value="marker">Marker Highlight</option>
                  <option value="underline">Underline</option>
                  <option value="box">Box Highlight</option>
                </select>
              </div>
              
              <div class="highlight-controls" *ngIf="canvasElements[selectedElement].highlightStyle !== 'none'">
                <div class="property-control">
                  <span>Highlight Color</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].highlightColor" (change)="updateElement()">
                </div>
                <div class="property-control">
                  <span>Opacity: {{canvasElements[selectedElement].highlightOpacity || 0.3}}</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].highlightOpacity" 
                         (change)="updateElement()" min="0.1" max="1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Text Transform</label>
          <div class="text-transform-controls">
            <div class="transform-actions">
              <button class="transform-btn" (click)="rotateText(-90)" title="Rotate Left">
                <mat-icon>rotate_left</mat-icon>
              </button>
              <button class="transform-btn" (click)="rotateText(90)" title="Rotate Right">
                <mat-icon>rotate_right</mat-icon>
              </button>
              <button class="transform-btn" (click)="flipText('horizontal')" title="Flip Horizontal">
                <mat-icon>flip</mat-icon>
              </button>
              <button class="transform-btn" (click)="flipText('vertical')" title="Flip Vertical">
                <mat-icon>flip</mat-icon>
              </button>
            </div>
            
            <div class="property-control">
              <span>Rotation: {{canvasElements[selectedElement].textRotation || 0}}°</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].textRotation" 
                     (change)="updateElement()" min="-180" max="180" step="5">
            </div>
            
            <div class="property-control">
              <span>Text Path</span>
              <select [(ngModel)]="canvasElements[selectedElement].textPath" (change)="updateElement()">
                <option value="none">None</option>
                <option value="arc">Arc</option>
                <option value="circle">Circle</option>
                <option value="wave">Wave</option>
              </select>
            </div>
            
            <div class="path-controls" *ngIf="canvasElements[selectedElement].textPath !== 'none'">
              <div class="property-control">
                <span>Path Strength: {{canvasElements[selectedElement].textPathStrength || 50}}</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].textPathStrength" 
                       (change)="updateElement()" min="0" max="100" step="5">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Image specific properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'image'">
        <div class="property-group">
          <label>Image</label>
          <div class="image-preview">
            <img [src]="canvasElements[selectedElement].src" [alt]="canvasElements[selectedElement].alt || 'Image'">
          </div>
          <button class="replace-image-btn" (click)="triggerUpload()">
            <mat-icon>photo_library</mat-icon>
            <span>Replace Image</span>
          </button>
        </div>
        
        <div class="property-group">
          <label>Image Appearance</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Object Fit</span>
              <select [(ngModel)]="canvasElements[selectedElement].objectFit" (change)="updateElement()">
                <option value="contain">Contain</option>
                <option value="cover">Cover</option>
                <option value="fill">Fill</option>
                <option value="scale-down">Scale Down</option>
              </select>
            </div>
            <div class="property-control">
              <span>Border Radius</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].borderRadius" (change)="updateElement()" min="0" max="100">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Transform</label>
          <div class="image-transform-grid">
            <button class="image-edit-btn" (click)="cropImage()">
              <mat-icon>crop</mat-icon>
              <span>Crop</span>
            </button>
            <button class="image-edit-btn" (click)="scaleImage()">
              <mat-icon>transform</mat-icon>
              <span>Scale</span>
            </button>
            <button class="image-edit-btn" (click)="rotateImage(-90)">
              <mat-icon>rotate_left</mat-icon>
              <span>Rotate Left</span>
            </button>
            <button class="image-edit-btn" (click)="rotateImage(90)">
              <mat-icon>rotate_right</mat-icon>
              <span>Rotate Right</span>
            </button>
            <button class="image-edit-btn" (click)="flipImage('horizontal')">
              <mat-icon>flip</mat-icon>
              <span>Flip H</span>
            </button>
            <button class="image-edit-btn" (click)="flipImage('vertical')">
              <mat-icon>flip</mat-icon>
              <span>Flip V</span>
            </button>
          </div>
          
          <div class="aspect-ratio-controls">
            <label>
              <input type="checkbox" [(ngModel)]="canvasElements[selectedElement].lockAspectRatio" (change)="updateElement()">
              Lock Aspect Ratio
            </label>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Filters</label>
          <div class="filter-tabs">
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'basic'}" (click)="activeImageFilterTab = 'basic'">Basic</button>
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'advanced'}" (click)="activeImageFilterTab = 'advanced'">Advanced</button>
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'blend'}" (click)="activeImageFilterTab = 'blend'">Blend</button>
          </div>
          
          <!-- Basic Filters -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'basic'">
            <div class="filter-sliders">
              <div class="filter-control">
                <span>Brightness: {{canvasElements[selectedElement].brightness || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].brightness" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Contrast: {{canvasElements[selectedElement].contrast || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].contrast" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Saturation: {{canvasElements[selectedElement].saturation || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].saturation" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Hue Rotate: {{canvasElements[selectedElement].hueRotate || 0}}°</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].hueRotate" 
                       (change)="updateImageFilters()" min="0" max="360" step="15" value="0">
              </div>
            </div>
          </div>
          
          <!-- Advanced Filters -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'advanced'">
            <div class="filter-sliders">
              <div class="filter-control">
                <span>Blur: {{canvasElements[selectedElement].blur || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].blur" 
                       (change)="updateImageFilters()" min="0" max="10" step="0.5" value="0">
              </div>
              <div class="filter-control">
                <span>Sepia: {{canvasElements[selectedElement].sepia || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].sepia" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
              <div class="filter-control">
                <span>Grayscale: {{canvasElements[selectedElement].grayscale || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].grayscale" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
              <div class="filter-control">
                <span>Invert: {{canvasElements[selectedElement].invert || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].invert" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
            </div>
          </div>
          
          <!-- Blend Modes -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'blend'">
            <div class="blend-controls">
              <div class="property-control">
                <span>Blend Mode</span>
                <select [(ngModel)]="canvasElements[selectedElement].blendMode" (change)="updateElement()">
                  <option value="normal">Normal</option>
                  <option value="multiply">Multiply</option>
                  <option value="screen">Screen</option>
                  <option value="overlay">Overlay</option>
                  <option value="soft-light">Soft Light</option>
                  <option value="hard-light">Hard Light</option>
                  <option value="color-dodge">Color Dodge</option>
                  <option value="color-burn">Color Burn</option>
                  <option value="darken">Darken</option>
                  <option value="lighten">Lighten</option>
                  <option value="difference">Difference</option>
                  <option value="exclusion">Exclusion</option>
                  <option value="luminosity">Luminosity</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="filter-presets">
            <button class="preset-filter-btn" (click)="applyFilterPreset('none')">Reset</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('vintage')">Vintage</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('blackwhite')">B&W</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('warm')">Warm</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('cool')">Cool</button>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Masking</label>
          <div class="masking-controls">
            <div class="mask-options">
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'rectangle'}"
                      (click)="applyMask('rectangle')">
                <mat-icon>crop_square</mat-icon>
                <span>Rectangle</span>
              </button>
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'circle'}"
                      (click)="applyMask('circle')">
                <mat-icon>radio_button_unchecked</mat-icon>
                <span>Circle</span>
              </button>
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'custom'}"
                      (click)="applyMask('custom')">
                <mat-icon>gesture</mat-icon>
                <span>Custom</span>
              </button>
              <button class="mask-btn" (click)="removeMask()">
                <mat-icon>clear</mat-icon>
                <span>Remove</span>
              </button>
            </div>
            
            <div class="mask-properties" *ngIf="canvasElements[selectedElement].maskType">
              <div class="property-control">
                <span>Feather: {{canvasElements[selectedElement].maskFeather || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].maskFeather" 
                       (change)="updateElement()" min="0" max="20" step="1">
              </div>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>PNG Transparency & Background Removal</label>
          <div class="transparency-controls">
            <button class="image-edit-btn" (click)="toggleBackgroundRemoval()" 
                    [ngClass]="{'active': isBackgroundRemovalActive()}">
              <mat-icon>content_cut</mat-icon>
              <span>Remove Background</span>
            </button>
            <button class="image-edit-btn" (click)="preserveTransparency()"
                    [ngClass]="{'active': canvasElements[selectedElement].preserveTransparency}">
              <mat-icon>transparency</mat-icon>
              <span>Preserve PNG Alpha</span>
            </button>
          </div>
        </div>
        
        <div class="property-group">
          <label>Effects</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Opacity</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].opacity" (change)="updateElement()" min="0.1" max="1" step="0.1">
              <span class="value-display">{{ canvasElements[selectedElement].opacity || 1 }}</span>
            </div>
            
            <div class="property-control">
              <span>Shadow</span>
              <select [(ngModel)]="canvasElements[selectedElement].boxShadow" (change)="updateElement()">
                <option value="none">None</option>
                <option value="0 2px 5px rgba(0,0,0,0.1)">Light</option>
                <option value="0 4px 8px rgba(0,0,0,0.2)">Medium</option>
                <option value="0 8px 16px rgba(0,0,0,0.3)">Strong</option>
              </select>
            </div>
            
            <div class="property-control">
              <span>Filter</span>
              <select [(ngModel)]="canvasElements[selectedElement].filter" (change)="updateElement()">
                <option value="none">None</option>
                <option value="grayscale(100%)">Grayscale</option>
                <option value="sepia(100%)">Sepia</option>
                <option value="blur(2px)">Blur</option>
                <option value="brightness(150%)">Brighten</option>
                <option value="contrast(150%)">Contrast</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Border</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Border Style</span>
              <select [(ngModel)]="canvasElements[selectedElement].border" (change)="updateElement()">
                <option value="none">None</option>
                <option value="1px solid #000">Thin</option>
                <option value="2px solid #000">Medium</option>
                <option value="3px solid #000">Thick</option>
                <option value="1px dashed #000">Dashed</option>
                <option value="1px dotted #000">Dotted</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Shape specific properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'shape'">
        <div class="property-group">
          <label>Shape Type</label>
          <div class="shape-controls">
            <div class="shape-selector">
              <span>Type</span>
              <select [(ngModel)]="canvasElements[selectedElement].shape" (change)="updateElement()">
                <option value="rectangle">Rectangle</option>
                <option value="circle">Circle</option>
                <option value="triangle">Triangle</option>
                <option value="ellipse">Ellipse</option>
                <option value="diamond">Diamond</option>
                <option value="hexagon">Hexagon</option>
                <option value="star">Star</option>
                <option value="heart">Heart</option>
                <option value="arrow">Arrow</option>
              </select>
            </div>
            
            <div class="color-control">
              <span>Fill Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].color" (change)="updateElement()">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Gradient</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Gradient Type</span>
              <select [(ngModel)]="canvasElements[selectedElement].gradientType" (change)="updateGradient()">
                <option value="">No Gradient</option>
                <option value="linear">Linear</option>
                <option value="radial">Radial</option>
              </select>
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType">
              <span>First Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].gradientStop1" (change)="updateGradient()">
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType">
              <span>Second Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].gradientStop2" (change)="updateGradient()">
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType === 'linear'">
              <span>Angle (°)</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].gradientAngle" (change)="updateGradient()" min="0" max="360" step="15">
              <span class="value-display">{{ canvasElements[selectedElement].gradientAngle || 0 }}°</span>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Shape Properties</label>
          <div class="property-controls">
            <div class="property-control" *ngIf="canvasElements[selectedElement].shape === 'rectangle'">
              <span>Border Radius</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].borderRadius" (change)="updateElement()" min="0" max="100">
            </div>
            
            <div class="property-control">
              <span>Opacity</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].opacity" (change)="updateElement()" min="0.1" max="1" step="0.1">
              <span class="value-display">{{ canvasElements[selectedElement].opacity || 1 }}</span>
            </div>
            
            <div class="property-control">
              <span>Rotation (°)</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].rotate" (change)="updateElement()" min="0" max="360">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Border & Effects</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Border</span>
              <select [(ngModel)]="canvasElements[selectedElement].border" (change)="updateElement()">
                <option value="none">None</option>
                <option value="1px solid #000">Thin</option>
                <option value="2px solid #000">Medium</option>
                <option value="3px solid #000">Thick</option>
                <option value="1px dashed #000">Dashed</option>
                <option value="1px dotted #000">Dotted</option>
              </select>
            </div>
            
            <div class="property-control">
              <span>Shadow</span>
              <select [(ngModel)]="canvasElements[selectedElement].boxShadow" (change)="updateElement()">
                <option value="none">None</option>
                <option value="0 2px 5px rgba(0,0,0,0.1)">Light</option>
                <option value="0 4px 8px rgba(0,0,0,0.2)">Medium</option>
                <option value="0 8px 16px rgba(0,0,0,0.3)">Strong</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            
            <div class="shadow-custom-controls" *ngIf="canvasElements[selectedElement].boxShadow === 'custom'">
              <div class="property-control">
                <span>Shadow Color</span>
                <input type="color" [(ngModel)]="canvasElements[selectedElement].shadowColor" (change)="updateCustomShadow()">
              </div>
              <div class="property-control">
                <span>Blur</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowBlur" (change)="updateCustomShadow()" min="0" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowBlur || 0 }}px</span>
              </div>
              <div class="property-control">
                <span>Offset X</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowOffsetX" (change)="updateCustomShadow()" min="-20" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowOffsetX || 0 }}px</span>
              </div>
              <div class="property-control">
                <span>Offset Y</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowOffsetY" (change)="updateCustomShadow()" min="-20" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowOffsetY || 0 }}px</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Custom Size Dialog -->
  <div class="dialog-overlay" *ngIf="showCustomSizeDialog">
    <div class="dialog-container">
      <div class="dialog-header">
        <h3>Custom Canvas Size</h3>
        <button class="close-btn" (click)="closeCustomSizeDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <div class="size-input-group">
          <div class="size-input">
            <label for="customWidth">Width (px)</label>
            <input type="number" id="customWidth" [(ngModel)]="customWidth" min="50" max="2000">
          </div>
          <div class="size-input">
            <label for="customHeight">Height (px)</label>
            <input type="number" id="customHeight" [(ngModel)]="customHeight" min="50" max="2000">
          </div>
        </div>
        <div class="preset-sizes">
          <h4>Preset Sizes</h4>
          <div class="preset-buttons">
            <button (click)="selectPresetSize('instagram')">Instagram Post</button>
            <button (click)="selectPresetSize('facebook')">Facebook Post</button>
            <button (click)="selectPresetSize('twitter')">Twitter Post</button>
            <button (click)="selectPresetSize('story')">Instagram Story</button>
            <button (click)="selectPresetSize('youtube')">YouTube Thumbnail</button>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeCustomSizeDialog()">Cancel</button>
        <button class="apply-btn" (click)="applyCustomSize()">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Image Crop Dialog -->
  <div class="dialog-overlay" *ngIf="showCropDialog">
    <div class="dialog-container crop-dialog">
      <div class="dialog-header">
        <h3>Crop Image</h3>
        <button class="close-btn" (click)="closeCropDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <div class="crop-container">
          <img #cropImage [src]="currentImageToCrop?.src" alt="Image to crop">
          <div class="crop-area" #cropArea
               [style.width.px]="cropWidth"
               [style.height.px]="cropHeight"
               [style.top.px]="cropTop"
               [style.left.px]="cropLeft"
               (mousedown)="startCropDrag($event)">
            <div class="resize-handle top-left" (mousedown)="startCropResize('top-left', $event)"></div>
            <div class="resize-handle top-right" (mousedown)="startCropResize('top-right', $event)"></div>
            <div class="resize-handle bottom-left" (mousedown)="startCropResize('bottom-left', $event)"></div>
            <div class="resize-handle bottom-right" (mousedown)="startCropResize('bottom-right', $event)"></div>
          </div>
        </div>
        <div class="crop-aspect-ratio">
          <span>Aspect Ratio:</span>
          <select [(ngModel)]="cropAspectRatio" (change)="applyCropAspectRatio()">
            <option value="free">Free</option>
            <option value="1:1">1:1 (Square)</option>
            <option value="4:3">4:3</option>
            <option value="16:9">16:9</option>
            <option value="3:4">3:4 (Portrait)</option>
            <option value="9:16">9:16 (Portrait)</option>
          </select>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeCropDialog()">Cancel</button>
        <button class="apply-btn" (click)="applyCrop()">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Share Link Dialog -->
  <div class="dialog-overlay" *ngIf="showShareDialog">
    <div class="dialog-container share-dialog">
      <div class="dialog-header">
        <h3>Share Template</h3>
        <button class="close-btn" (click)="closeShareDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <p>Share this link with others to let them view or edit this template:</p>
        <div class="share-link">
          <input type="text" [value]="shareLink" readonly #shareLinkInput>
          <button (click)="copyShareLink(shareLinkInput)">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
        <div class="share-permissions">
          <h4>Permissions</h4>
          <div class="permission-option">
            <input type="radio" id="view-only" name="permission" value="view" [(ngModel)]="sharePermission">
            <label for="view-only">View only</label>
          </div>
          <div class="permission-option">
            <input type="radio" id="can-edit" name="permission" value="edit" [(ngModel)]="sharePermission">
            <label for="can-edit">Can edit</label>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeShareDialog()">Close</button>
        <button class="apply-btn" (click)="generateNewShareLink()">Generate New Link</button>
      </div>
    </div>
  </div>
</div>
