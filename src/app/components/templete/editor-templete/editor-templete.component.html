<div class="template-editor-container">
  <!-- Mobile Navigation Buttons (Visible only on small screens) -->
  <div class="mobile-nav-buttons">
    <button [ngClass]="{'active': activeMobilePanel === 'sidebar'}" (click)="toggleMobilePanel('sidebar')">
      <mat-icon>dashboard</mat-icon>
      <span>Elements</span>
    </button>
    <button [ngClass]="{'active': activeMobilePanel === 'canvas'}" (click)="toggleMobilePanel('canvas')">
      <mat-icon>brush</mat-icon>
      <span>Canvas</span>
    </button>
    <button [ngClass]="{'active': activeMobilePanel === 'properties'}" (click)="toggleMobilePanel('properties')" [disabled]="selectedElement === null">
      <mat-icon>tune</mat-icon>
      <span>Properties</span>
    </button>
  </div>

  <div class="template-editor-header">
    <div class="header-left">
      <div class="app-logo">
        <mat-icon>design_services</mat-icon>
        <h2 class="template-editor-title">Template Studio</h2>
      </div>
      <div class="template-info">
        <input type="text" class="template-name-input" [(ngModel)]="template.name" placeholder="Untitled Template">
        <select class="template-type-select" [(ngModel)]="template.type">
          <option value="">Select type</option>
          <option *ngFor="let type of templateTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>
    </div>
    <div class="header-actions">
      <div class="history-controls">
        <button class="history-btn" [disabled]="!canUndo" (click)="undo()" title="Undo">
          <mat-icon>undo</mat-icon>
        </button>
        <button class="history-btn" [disabled]="!canRedo" (click)="redo()" title="Redo">
          <mat-icon>redo</mat-icon>
        </button>
      </div>
      <button class="preview-btn" title="Preview" (click)="previewTemplate()">
        <mat-icon>visibility</mat-icon>
      </button>
      <div class="export-btn-wrapper">
        <button class="export-btn" (click)="toggleExportOptions()">
          <mat-icon>download</mat-icon>
          <span>Export</span>
        </button>
        <div class="export-options" *ngIf="showExportOptions">
          <button (click)="exportTemplate('png', 'standard')">PNG (Standard)</button>
          <button (click)="exportTemplate('png', 'high')">PNG (High-Res)</button>
          <button (click)="exportTemplate('jpg', 'standard')">JPG (Standard)</button>
          <button (click)="exportTemplate('jpg', 'high')">JPG (High-Res)</button>
          <button (click)="exportTemplate('pdf', 'standard')">PDF</button>
          <button (click)="generateShareLink()">Share Link</button>
        </div>
      </div>
      <button class="save-btn" (click)="saveTemplateWithImageConversion()">
        <mat-icon>save</mat-icon>
        <span>Save</span>
      </button>
      <button class="exit-btn" (click)="cancelEdit()">Exit</button>
    </div>
  </div>
  
  <div class="template-editor-body">
    <div class="sidebar" [ngClass]="{'mobile-active': activeMobilePanel === 'sidebar'}">
      <!-- Text Elements Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <mat-icon>text_fields</mat-icon>
          Text Elements
        </h3>
        
        <!-- Text Types Grid -->
        <div class="text-elements-grid">
          <div class="text-element-item" (click)="addTextElement('heading')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'heading'})" (dragend)="onDragEnd()">
            <div class="text-icon">
              <mat-icon>title</mat-icon>
            </div>
            <div class="element-preview">
              <span class="preview-text heading-preview">Add a heading</span>
              <span class="element-label">Heading</span>
            </div>
          </div>
          
          <div class="text-element-item" (click)="addTextElement('subheading')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'subheading'})" (dragend)="onDragEnd()">
            <div class="text-icon">
              <mat-icon>format_h2</mat-icon>
            </div>
            <div class="element-preview">
              <span class="preview-text subheading-preview">Add a subheading</span>
              <span class="element-label">Subheading</span>
            </div>
          </div>
          
          <div class="text-element-item" (click)="addTextElement('body')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'body'})" (dragend)="onDragEnd()">
            <div class="text-icon">
              <mat-icon>article</mat-icon>
            </div>
            <div class="element-preview">
              <span class="preview-text body-preview">Add a little bit of body text</span>
              <span class="element-label">Body Text</span>
            </div>
          </div>
          
          <div class="text-element-item" (click)="addTextElement('caption')" 
               draggable="true" (dragstart)="onDragStart($event, 'text', {textType: 'caption'})" (dragend)="onDragEnd()">
            <div class="text-icon">
              <mat-icon>text_fields_alt</mat-icon>
            </div>
            <div class="element-preview">
              <span class="preview-text caption-preview">Add a caption</span>
              <span class="element-label">Caption</span>
            </div>
          </div>
        </div>

        <!-- Typography Combos -->
        <div class="typography-section">
          <h4 class="subsection-title">
            <mat-icon>font_download</mat-icon>
            Typography Combos
          </h4>
          <div class="typography-combos">
            <div class="combo-item" 
                 *ngFor="let combo of typographyCombos; trackBy: trackByCombo" 
                 (click)="applyTypographyCombo(combo)"
                 [title]="'Click to add ' + combo.name + ' typography combo to canvas'">
              <div class="combo-preview">
                <div class="combo-heading" [ngStyle]="getComboHeadingStyle(combo)">{{ combo.headingText }}</div>
                <div class="combo-body" [ngStyle]="getComboBodyStyle(combo)">{{ combo.bodyText }}</div>
              </div>
              <div class="combo-info">
                <span class="combo-name">{{ combo.name }}</span>
                <span class="combo-fonts">{{ combo.headingFont }} & {{ combo.bodyFont }}</span>
              </div>
            </div>
            
            <!-- Loading state -->
            <div *ngIf="typographyCombos.length === 0" class="combo-loading">
              <mat-icon>hourglass_empty</mat-icon>
              <span>Loading typography combos...</span>
            </div>
          </div>
        </div>

        <!-- Text Effects Quick Access -->
        <div class="text-effects-section">
          <h4 class="subsection-title">Text Effects</h4>
          <div class="effects-quick-grid">
            <button class="effect-btn" (click)="applyTextEffect('shadow')" 
                    [class.active]="hasEffect('shadow')" title="Shadow">
              <mat-icon>layers</mat-icon>
              <span>Shadow</span>
            </button>
            <button class="effect-btn" (click)="applyTextEffect('outline')" 
                    [class.active]="hasEffect('outline')" title="Outline">
              <mat-icon>border_outer</mat-icon>
              <span>Outline</span>
            </button>
            <button class="effect-btn" (click)="applyTextEffect('gradient')" 
                    [class.active]="hasEffect('gradient')" title="Gradient">
              <mat-icon>gradient</mat-icon>
              <span>Gradient</span>
            </button>
            <button class="effect-btn" (click)="applyTextEffect('neon')" 
                    [class.active]="hasEffect('neon')" title="Neon Glow">
              <mat-icon>flare</mat-icon>
              <span>Neon</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Font Library Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">
          <mat-icon>font_download</mat-icon>
          Font Library
        </h3>
        
        <!-- Font Search -->
        <div class="font-search">
          <mat-icon>search</mat-icon>
          <input type="text" 
                 [(ngModel)]="fontSearchQuery" 
                 placeholder="Search fonts..." 
                 (input)="filterFonts()">
        </div>

        <!-- Font Categories -->
        <div class="font-categories">
          <button class="category-btn" 
                  [class.active]="activeFontCategory === 'all'"
                  (click)="setFontCategory('all')">All</button>
          <button class="category-btn" 
                  [class.active]="activeFontCategory === 'sans-serif'"
                  (click)="setFontCategory('sans-serif')">Sans-serif</button>
          <button class="category-btn" 
                  [class.active]="activeFontCategory === 'serif'"
                  (click)="setFontCategory('serif')">Serif</button>
          <button class="category-btn" 
                  [class.active]="activeFontCategory === 'display'"
                  (click)="setFontCategory('display')">Display</button>
          <button class="category-btn" 
                  [class.active]="activeFontCategory === 'handwriting'"
                  (click)="setFontCategory('handwriting')">Script</button>
        </div>

        <!-- Font List -->
        <div class="font-list">
          <div class="font-item" *ngFor="let font of filteredFonts; trackBy: trackByFont" 
               (click)="applyFont(font)"
               [class.selected]="isSelectedFont(font)">
            <div class="font-preview" [ngStyle]="getFontPreviewStyle(font)">
              {{ font.previewText || 'The quick brown fox' }}
            </div>
            <div class="font-info">
              <span class="font-name">{{ font.name }}</span>
              <span class="font-category">{{ font.category }}</span>
              <mat-icon class="premium-icon" *ngIf="font.premium">star</mat-icon>
            </div>
          </div>
        </div>

        <!-- Font Pairing Suggestions -->
        <div class="font-pairing-section" *ngIf="selectedElement !== null && canvasElements[selectedElement]?.type === 'text'">
          <h4 class="subsection-title">Suggested Pairings</h4>
          <div class="pairing-suggestions">
            <div class="pairing-item" *ngFor="let pairing of fontPairingSuggestions" 
                 (click)="applyFontPairing(pairing)">
              <div class="pairing-preview">
                <div class="pairing-primary" [ngStyle]="getPairingPrimaryStyle(pairing)">{{ pairing.primarySample }}</div>
                <div class="pairing-secondary" [ngStyle]="getPairingSecondaryStyle(pairing)">{{ pairing.secondarySample }}</div>
              </div>
              <div class="pairing-info">
                <span class="pairing-name">{{ pairing.name }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom Font Upload -->
        <div class="custom-font-upload">
          <button class="upload-font-btn" (click)="triggerFontUpload()">
            <mat-icon>upload</mat-icon>
            <span>Upload Custom Font</span>
          </button>
          <input type="file" 
                 #fontUploadRef 
                 style="display: none" 
                 accept=".ttf,.otf,.woff,.woff2"
                 (change)="onFontFileSelected($event)">
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3 class="sidebar-title">Media & Shapes</h3>
        <div class="elements-list">
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'image')" (dragend)="onDragEnd()">
            <mat-icon>photo</mat-icon>
            <span>Image</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'shape')" (dragend)="onDragEnd()" (click)="openShapeSelector()">
            <mat-icon>shapes</mat-icon>
            <span>Shape</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'line')" (dragend)="onDragEnd()">
            <mat-icon>show_chart</mat-icon>
            <span>Line</span>
          </div>
          <div class="element-item" draggable="true" (dragstart)="onDragStart($event, 'icon')" (dragend)="onDragEnd()">
            <mat-icon>star</mat-icon>
            <span>Icon</span>
          </div>
        </div>
        
        <!-- Shape Selector Expanded Panel -->
        <div class="shapes-panel" *ngIf="showShapeSelector">
          <div class="shapes-header">
            <h3 class="shapes-title">Select Shape</h3>
            <div class="shapes-search">
              <mat-icon>search</mat-icon>
              <input type="text" 
                     [(ngModel)]="shapeSearchQuery" 
                     placeholder="Search shapes..." 
                     (input)="filterShapes()">
            </div>
          </div>
          
          <!-- Shape Categories Tabs -->
          <div class="shape-categories">
            <button class="category-tab" 
                    [ngClass]="{'active': activeShapeCategory === 'all'}"
                    (click)="setActiveCategory('all')">
              <mat-icon>apps</mat-icon>
              <span>All</span>
            </button>
            <button class="category-tab" 
                    [ngClass]="{'active': activeShapeCategory === 'basic'}"
                    (click)="setActiveCategory('basic')">
              <mat-icon>crop_square</mat-icon>
              <span>Basic</span>
            </button>
            <button class="category-tab" 
                    [ngClass]="{'active': activeShapeCategory === 'geometric'}"
                    (click)="setActiveCategory('geometric')">
              <mat-icon>hexagon</mat-icon>
              <span>Geometric</span>
            </button>
            <button class="category-tab" 
                    [ngClass]="{'active': activeShapeCategory === 'lines'}"
                    (click)="setActiveCategory('lines')">
              <mat-icon>show_chart</mat-icon>
              <span>Lines</span>
            </button>
            <button class="category-tab" 
                    [ngClass]="{'active': activeShapeCategory === 'special'}"
                    (click)="setActiveCategory('special')">
              <mat-icon>star</mat-icon>
              <span>Special</span>
            </button>
          </div>
          <!-- Filtered Shapes Grid -->
          <div class="shapes-container">
            <div class="shapes-grid" *ngIf="filteredShapes.length > 0">
              <div class="shape-option" 
                   *ngFor="let shape of filteredShapes; trackBy: trackByShape"
                   [attr.data-shape]="shape.type"
                   (click)="addShapeToCanvas(shape.type)"
                   (mouseenter)="onShapeHover(shape, $event)"
                   (mouseleave)="onShapeLeave()">
                <div class="shape-preview">
                  <div class="shape-icon" [ngClass]="getShapeIconClass(shape.type)">
                    <mat-icon>{{ getShapeIcon(shape.type) }}</mat-icon>
                  </div>
                  <div class="shape-visual" [ngClass]="getShapeVisualClass(shape.type)"></div>
                </div>
                <span class="shape-label">{{ shape.name }}</span>
                <div class="shape-tooltip">{{ shape.name }}</div>
              </div>
            </div>
            
            <!-- No Results Message -->
            <div class="no-shapes" *ngIf="filteredShapes.length === 0 && shapeSearchQuery">
              <mat-icon>search_off</mat-icon>
              <p>No shapes found for "{{ shapeSearchQuery }}"</p>
              <button class="clear-search-btn" (click)="clearShapeSearch()">
                <mat-icon>clear</mat-icon>
                Clear search
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Color Palette Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">Color Palette</h3>
        <div class="color-palette-container">
          <div class="palette-tabs">
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'saved'}" (click)="activePaletteTab = 'saved'">Saved</button>
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'recent'}" (click)="activePaletteTab = 'recent'">Recent</button>
            <button class="palette-tab" [ngClass]="{'active': activePaletteTab === 'brand'}" (click)="activePaletteTab = 'brand'">Brand</button>
          </div>
          
          <!-- Saved Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'saved'">
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of savedColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   (contextmenu)="removeColor(color, $event)"
                   [title]="color">
              </div>
              <div class="add-color-swatch" (click)="openColorPicker()">
                <mat-icon>add</mat-icon>
              </div>
            </div>
          </div>
          
          <!-- Recent Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'recent'">
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of recentColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   [title]="color">
              </div>
            </div>
          </div>
          
          <!-- Brand Colors -->
          <div class="palette-content" *ngIf="activePaletteTab === 'brand'">
            <div class="brand-palette-controls">
              <button class="brand-btn" (click)="saveBrandPalette()">Save Current as Brand</button>
              <button class="brand-btn" (click)="loadBrandPalette()">Load Brand Palette</button>
            </div>
            <div class="color-swatches">
              <div class="color-swatch" 
                   *ngFor="let color of brandColors" 
                   [style.background-color]="color"
                   (click)="selectColor(color)"
                   [title]="color">
              </div>
            </div>
          </div>
          
          <!-- Color Picker -->
          <div class="advanced-color-picker" *ngIf="showColorPicker">
            <div class="color-picker-header">
              <h4>Color Picker</h4>
              <button class="close-picker" (click)="closeColorPicker()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div class="color-picker-content">
              <input type="color" [(ngModel)]="pickerColor" (change)="updatePickerColor()">
              <div class="color-inputs">
                <div class="color-input-group">
                  <label>HEX</label>
                  <input type="text" [(ngModel)]="hexColor" (change)="updateFromHex()">
                </div>
                <div class="color-input-group">
                  <label>RGB</label>
                  <div class="rgb-inputs">
                    <input type="number" [(ngModel)]="rgbColor.r" (change)="updateFromRGB()" min="0" max="255">
                    <input type="number" [(ngModel)]="rgbColor.g" (change)="updateFromRGB()" min="0" max="255">
                    <input type="number" [(ngModel)]="rgbColor.b" (change)="updateFromRGB()" min="0" max="255">
                  </div>
                </div>
              </div>
              <div class="opacity-control">
                <label>Opacity: {{colorOpacity || 1}}</label>
                <input type="range" [(ngModel)]="colorOpacity" min="0" max="1" step="0.1">
              </div>
              <button class="add-to-palette-btn" (click)="addToPalette()">Add to Palette</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Canvas Background Section -->
      <div class="sidebar-section">
        <h3 class="sidebar-title">Canvas Background</h3>
        <div class="background-controls">
          <div class="background-type-selector">
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'color'}"
                    (click)="setBackgroundType('color')">
              <mat-icon>palette</mat-icon>
              <span>Color</span>
            </button>
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'gradient'}"
                    (click)="setBackgroundType('gradient')">
              <mat-icon>gradient</mat-icon>
              <span>Gradient</span>
            </button>
            <button class="bg-type-btn" 
                    [ngClass]="{'active': canvasBackground.type === 'image'}"
                    (click)="setBackgroundType('image')">
              <mat-icon>image</mat-icon>
              <span>Image</span>
            </button>
          </div>
          
          <!-- Solid Color Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'color'">
            <div class="color-picker-group">
              <label>Background Color</label>
              <input type="color" [(ngModel)]="canvasBackground.color" (change)="updateCanvasBackground()">
            </div>
          </div>
          
          <!-- Gradient Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'gradient'">
            <div class="gradient-controls">
              <div class="gradient-type">
                <label>Gradient Type</label>
                <select [(ngModel)]="canvasBackground.gradientType" (change)="updateCanvasBackground()">
                  <option value="linear">Linear</option>
                  <option value="radial">Radial</option>
                </select>
              </div>
              <div class="gradient-colors">
                <div class="color-stop">
                  <label>Color 1</label>
                  <input type="color" [(ngModel)]="canvasBackground.gradientColor1" (change)="updateCanvasBackground()">
                </div>
                <div class="color-stop">
                  <label>Color 2</label>
                  <input type="color" [(ngModel)]="canvasBackground.gradientColor2" (change)="updateCanvasBackground()">
                </div>
              </div>
              <div class="gradient-angle" *ngIf="canvasBackground.gradientType === 'linear'">
                <label>Angle: {{canvasBackground.gradientAngle || 45}}°</label>
                <input type="range" [(ngModel)]="canvasBackground.gradientAngle" 
                       (change)="updateCanvasBackground()" min="0" max="360" step="15">
              </div>
            </div>
          </div>
          
          <!-- Image Background -->
          <div class="bg-options" *ngIf="canvasBackground.type === 'image'">
            <div class="image-bg-controls">
              <button class="upload-bg-btn" (click)="triggerBackgroundUpload()">
                <mat-icon>cloud_upload</mat-icon>
                <span>Upload Background</span>
              </button>
              <input type="file" #backgroundUpload style="display: none" 
                     (change)="onBackgroundSelected($event)" accept="image/*">
              
              <div class="bg-image-preview" *ngIf="canvasBackground.imageUrl">
                <img [src]="canvasBackground.imageUrl" alt="Background">
                <button class="remove-bg-btn" (click)="removeBackgroundImage()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              
              <div class="bg-image-options" *ngIf="canvasBackground.imageUrl">
                <div class="bg-option">
                  <label>Opacity: {{canvasBackground.opacity || 1}}</label>
                  <input type="range" [(ngModel)]="canvasBackground.opacity" 
                         (change)="updateCanvasBackground()" min="0.1" max="1" step="0.1">
                </div>
                <div class="bg-option">
                  <label>Blur: {{canvasBackground.blur || 0}}px</label>
                  <input type="range" [(ngModel)]="canvasBackground.blur" 
                         (change)="updateCanvasBackground()" min="0" max="10" step="1">
                </div>
                <div class="bg-option">
                  <label>Overlay Color</label>
                  <input type="color" [(ngModel)]="canvasBackground.overlayColor" 
                         (change)="updateCanvasBackground()">
                </div>
                <div class="bg-option">
                  <label>Overlay Opacity: {{canvasBackground.overlayOpacity || 0}}</label>
                  <input type="range" [(ngModel)]="canvasBackground.overlayOpacity" 
                         (change)="updateCanvasBackground()" min="0" max="1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h3 class="sidebar-title">Media</h3>
        <div class="upload-options">
          <div class="upload-method">
            <button class="upload-btn" (click)="triggerUpload()">
              <mat-icon>cloud_upload</mat-icon>
              <span>Upload Image</span>
            </button>
            <input type="file" #fileUpload style="display: none" (change)="onFileSelected($event)" accept="image/*">
          </div>
        </div>
        
        <div class="uploads-list" *ngIf="uploads.length > 0">
          <div class="upload-item" *ngFor="let upload of uploads" (click)="addElementToCanvas('image', upload)">
            <img [src]="upload.url" [alt]="upload.name">
            <button class="delete-upload-btn" (click)="deleteUpload(upload.id, $event)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="canvas-container" [ngClass]="{'mobile-active': activeMobilePanel === 'canvas'}">
      <div class="canvas-toolbar">
        <div class="toolbar-section">
          <div class="canvas-info">
            <span class="canvas-dimensions">{{canvasWidth}} x {{canvasHeight}} px</span>
            <button class="tool-btn" (click)="openCustomSizeDialog()" title="Change Canvas Size">
              <mat-icon>photo_size_select_large</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="canvas-tools">
            <button class="tool-btn" [ngClass]="{'active': showGrid}" (click)="toggleGrid()" title="Toggle Grid">
              <mat-icon>grid_4x4</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': snapToGrid}" (click)="toggleSnapToGrid()" title="Snap to Grid">
              <mat-icon>grid_goldenratio</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': showAlignmentGuides}" (click)="toggleAlignmentGuides()" title="Alignment Guides">
              <mat-icon>align_horizontal_center</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': showSmartGuides}" (click)="toggleSmartGuides()" title="Smart Guides">
              <mat-icon>grid_goldenratio</mat-icon>
            </button>
            <button class="tool-btn" [ngClass]="{'active': snapToGuides}" (click)="toggleSnapToGuides()" title="Snap to Guides">
              <mat-icon>magnet</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="view-controls">
            <button class="view-btn" (click)="fitToScreen()" title="Fit to Screen">
              <mat-icon>fit_screen</mat-icon>
            </button>
            <button class="view-btn" (click)="actualSize()" title="Actual Size (100%)">
              <mat-icon>aspect_ratio</mat-icon>
            </button>
            <button class="view-btn" (click)="centerCanvas()" title="Center Canvas">
              <mat-icon>center_focus_strong</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="toolbar-section">
          <div class="zoom-controls">
            <button class="zoom-btn" (click)="setZoom(25)" title="25%">25%</button>
            <button class="zoom-btn" (click)="setZoom(50)" title="50%">50%</button>
            <button class="zoom-btn" (click)="zoom(-10)" title="Zoom Out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <span class="zoom-level">{{ zoomLevel }}%</span>
            <button class="zoom-btn" (click)="zoom(10)" title="Zoom In">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button class="zoom-btn" (click)="setZoom(100)" title="100%">100%</button>
            <button class="zoom-btn" (click)="setZoom(200)" title="200%">200%</button>
          </div>
        </div>
      </div>
      
      <div class="canvas-workspace" 
           [style.transform]="'scale(' + zoomLevel/100 + ') translate(' + panX + 'px, ' + panY + 'px)'" 
           [style.transform-origin]="'center center'"
           (drop)="onDrop($event)" 
           (dragover)="onDragOver($event)"
           (mousedown)="startPan($event)"
           (wheel)="onWheel($event)"
           (touchstart)="onTouchStart($event)"
           (touchmove)="onTouchMove($event)">
           
        <!-- Rulers -->
        <div class="rulers" *ngIf="showRulers">
          <div class="ruler horizontal-ruler"></div>
          <div class="ruler vertical-ruler"></div>
        </div>
        
        <div class="canvas" #canvas 
             [style.width.px]="canvasWidth" 
             [style.height.px]="canvasHeight" 
             [ngClass]="{'show-grid': showGrid}"
             [style.background]="getCanvasBackgroundStyle()"
             (drop)="onDrop($event)" 
             (dragover)="onDragOver($event)"
             (click)="onCanvasClick($event)">
             
          <!-- Grid overlay for snap-to-grid -->
          <div class="grid-overlay" *ngIf="showGrid"
               [style.background-size]="gridSize + 'px ' + gridSize + 'px'"></div>
          
          <!-- Alignment guides -->
          <div class="alignment-guides" *ngIf="showAlignmentGuides && selectedElement !== null">
            <div class="guide horizontal-center" *ngIf="showHorizontalCenterGuide"></div>
            <div class="guide vertical-center" *ngIf="showVerticalCenterGuide"></div>
            <div class="guide left-edge" *ngIf="showLeftEdgeGuide"></div>
            <div class="guide right-edge" *ngIf="showRightEdgeGuide"></div>
            <div class="guide top-edge" *ngIf="showTopEdgeGuide"></div>
            <div class="guide bottom-edge" *ngIf="showBottomEdgeGuide"></div>
          </div>
          
          <!-- Smart guides -->
          <div class="smart-guides" *ngIf="showSmartGuides && guideLines.length > 0">
            <div class="guide-line" 
                 *ngFor="let guide of guideLines" 
                 [ngClass]="{'horizontal': guide.y !== undefined, 'vertical': guide.x !== undefined}"
                 [style.left.px]="guide.x"
                 [style.top.px]="guide.y">
            </div>
          </div>
          <!-- Canvas elements will be rendered here -->
          <div *ngFor="let element of canvasElements; let i = index" 
               class="canvas-element" 
               [ngClass]="getElementClasses(i)" 
               [attr.data-selection-index]="selectedElements.length > 1 && selectedElements.includes(i) ? (selectedElements.indexOf(i) + 1) : null"
               [attr.data-element-index]="i"
               [style.left.px]="element.x" 
               [style.top.px]="element.y"
               [style.width.px]="element.width"
               [style.height.px]="element.height"
               [style.z-index]="i + 1"
               [style.transform]="getElementTransform(element)"
               [style.opacity]="element.hidden ? 0 : (element.opacity || 1)"
               [style.pointer-events]="element.locked ? 'none' : 'auto'"
               [style.mix-blend-mode]="element.blendMode || 'normal'"
               (mouseenter)="onElementMouseEnter(i)"
               (mouseleave)="onElementMouseLeave()"
               (mousedown)="selectElement(i, $event)">
            
            <!-- Text element -->
            <div *ngIf="element.type === 'text'" 
                 class="text-element" 
                 [style.fontSize.px]="element.fontSize"
                 [style.color]="getTextColor(element)"
                 [style.background]="getTextGradient(element)"
                 [style.webkitBackgroundClip]="element.textGradientType && element.textGradientType !== 'none' ? 'text' : 'unset'"
                 [style.webkitTextFillColor]="element.textGradientType && element.textGradientType !== 'none' ? 'transparent' : 'unset'"
                 [style.fontFamily]="element.fontFamily"
                 [style.fontWeight]="element.fontWeight"
                 [style.fontStyle]="element.fontStyle"
                 [style.textDecoration]="element.textDecoration"
                 [style.textAlign]="element.textAlign"
                 [style.backgroundColor]="getTextBackgroundColor(element)"
                 [style.padding.px]="element.padding"
                 [style.borderRadius.px]="element.borderRadius"
                 [style.lineHeight]="element.lineHeight"
                 [style.letterSpacing.px]="element.letterSpacing"
                 [style.textTransform]="element.textTransform"
                 [style.webkitTextStrokeWidth.px]="element.textStrokeWidth"
                 [style.webkitTextStrokeColor]="element.textStrokeColor"
                 [style.textShadow]="element.textShadow"
                 [style.transform]="getTextTransform(element)"
                 [style.opacity]="element.opacity || 1"
                 [contentEditable]="selectedElement === i"
                 (blur)="updateElementContent(i, $event)"
                 (focus)="selectedElement = i">
              {{ element.content }}
            </div>
            
            <!-- Image element -->
            <img *ngIf="element.type === 'image'" 
                 [src]="element.src" 
                 [alt]="element.alt || 'Image'" 
                 class="image-element"
                 [style.objectFit]="element.objectFit || 'contain'"
                 [style.objectPosition]="element.objectPosition || 'center'"
                 [style.borderRadius.px]="element.borderRadius"
                 [style.border]="element.border"
                 [style.boxShadow]="element.boxShadow"
                 [style.filter]="getImageFilter(element)"
                 [style.opacity]="element.opacity || 1"
                 [style.clipPath]="getImageMask(element)">
            
            <!-- Shape element -->
            <div *ngIf="element.type === 'shape'" 
                 class="shape-element"
                 [style.background]="getShapeBackground(element)"
                 [style.borderRadius.px]="getShapeBorderRadius(element)"
                 [style.clipPath]="getShapeClipPath(element)"
                 [style.boxShadow]="element.boxShadow"
                 [style.opacity]="element.opacity || 1"
                 [style.border]="element.border">
            </div>

            <!-- Line element -->
            <div *ngIf="element.type === 'line'" 
                 class="line-element"
                 [style.backgroundColor]="element.color"
                 [style.width.px]="element.width"
                 [style.height.px]="element.lineWidth || 2"
                 [style.opacity]="element.opacity || 1">
            </div>

            <!-- Icon element -->
            <div *ngIf="element.type === 'icon'" 
                 class="icon-element"
                 [style.backgroundImage]="'url(' + element.src + ')'"
                 [style.backgroundSize]="'contain'"
                 [style.backgroundRepeat]="'no-repeat'"
                 [style.backgroundPosition]="'center'"
                 [style.filter]="getIconFilter(element)"
                 [style.opacity]="element.opacity || 1">
            </div>
            
            <!-- Resize handles (only show for selected element) -->
            <div *ngIf="selectedElement === i" class="resize-handles">
              <div class="resize-handle top-left" (mousedown)="startResize(i, 'top-left', $event)"></div>
              <div class="resize-handle top-right" (mousedown)="startResize(i, 'top-right', $event)"></div>
              <div class="resize-handle bottom-left" (mousedown)="startResize(i, 'bottom-left', $event)"></div>
              <div class="resize-handle bottom-right" (mousedown)="startResize(i, 'bottom-right', $event)"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mobile Canvas Controls -->
      <div class="canvas-controls mobile-only">
        <div class="zoom-controls">
          <button class="zoom-btn" (click)="setZoom(50)" title="50%">50%</button>
          <button class="zoom-btn" (click)="setZoom(75)" title="75%">75%</button>
          <button class="zoom-btn" (click)="setZoom(100)" title="100%">100%</button>
          <button class="zoom-btn" (click)="fitToScreen()" title="Fit">
            <mat-icon>fit_screen</mat-icon>
          </button>
        </div>
      </div>
    </div>
    
    <div class="properties-panel" [ngClass]="{'mobile-active': activeMobilePanel === 'properties'}">
      
      <!-- Layer Management Panel -->
      <div class="layer-management" *ngIf="canvasElements.length > 0">
        <div class="layer-header">
          <h3 class="panel-title">Layers</h3>
          <div class="layer-actions">
            <button class="layer-action-btn" title="Isolate Selected Layer" (click)="isolateLayer()" 
                    [disabled]="selectedElement === null && selectedElements.length === 0">
              <mat-icon>{{ isLayerIsolated ? 'visibility' : 'visibility_off' }}</mat-icon>
            </button>
            <button class="layer-action-btn" title="Select All" (click)="selectAllElements()">
              <mat-icon>checklist</mat-icon>
            </button>
            <button class="layer-action-btn" title="Group Selected" (click)="groupSelectedElements()" 
                    [disabled]="selectedElements.length < 2">
              <mat-icon>group</mat-icon>
            </button>
            <button class="layer-action-btn" title="Ungroup Selected" (click)="ungroupSelectedElements()"
                    [disabled]="!hasGroupedElements()">
              <mat-icon>ungroup</mat-icon>
            </button>
          </div>
        </div>
        
        <div class="layer-search">
          <input type="text" 
                 placeholder="Search layers..." 
                 [(ngModel)]="layerSearchQuery" 
                 (input)="filterLayers()"
                 class="layer-search-input">
          <mat-icon class="search-icon">search</mat-icon>
        </div>
        
        <div class="layers-list">
          <div class="layer-item" 
               *ngFor="let element of filteredCanvasElements; let i = index; trackBy: trackByElementId"
               [ngClass]="{'selected': selectedElement === i || selectedElements.includes(i), 
                          'locked': element.locked, 
                          'hidden': element.hidden,
                          'dragging': draggedLayerIndex === i}"
               [attr.draggable]="!element.locked"
               (dragstart)="onLayerDragStart($event, i)"
               (dragover)="onLayerDragOver($event, i)"
               (drop)="onLayerDrop($event, i)"
               (dragend)="onLayerDragEnd($event)"
               (click)="selectLayer(i, $event)"
               (dblclick)="startLayerRename(i)">
            
            <div class="layer-content">
              <div class="layer-icon">
                <mat-icon *ngIf="element.type === 'text'">text_fields</mat-icon>
                <mat-icon *ngIf="element.type === 'image'">photo</mat-icon>
                <mat-icon *ngIf="element.type === 'shape'">shapes</mat-icon>
                <mat-icon *ngIf="element.type === 'line'">show_chart</mat-icon>
              </div>
              
              <div class="layer-info">
                <span class="layer-name" *ngIf="!element.editing">
                  {{ element.layerName || getDefaultLayerName(element, i) }}
                </span>
                <input class="layer-name-input" 
                       *ngIf="element.editing"
                       [(ngModel)]="element.layerName" 
                       (blur)="finishLayerRename(i)"
                       (keydown.enter)="finishLayerRename(i)"
                       (keydown.escape)="cancelLayerRename(i)">
                <div class="layer-details">
                  <span class="layer-type">{{ element.type | titlecase }}</span>
                  <span class="layer-size">{{ element.width }}x{{ element.height }}</span>
                </div>
              </div>
            </div>
            
            <div class="layer-controls">
              <button class="layer-control-btn" 
                      [ngClass]="{'active': !element.hidden}"
                      (click)="toggleLayerVisibility(i, $event)" 
                      title="Toggle Visibility">
                <mat-icon>{{ element.hidden ? 'visibility_off' : 'visibility' }}</mat-icon>
              </button>
              <button class="layer-control-btn" 
                      [ngClass]="{'active': element.locked}"
                      (click)="toggleLayerLock(i, $event)" 
                      title="Toggle Lock">
                <mat-icon>{{ element.locked ? 'lock' : 'lock_open' }}</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Element Properties (only show if element is selected) -->
      <div class="element-properties" *ngIf="selectedElement !== null">
        <h3 class="panel-title">Properties</h3>
        
        <div class="quick-actions">
          <button class="action-btn" title="Bring to Front" (click)="bringToFront()">
            <mat-icon>flip_to_front</mat-icon>
          </button>
          <button class="action-btn" title="Bring Forward" (click)="bringForward()">
            <mat-icon>keyboard_arrow_up</mat-icon>
          </button>
          <button class="action-btn" title="Send Backward" (click)="sendBackward()">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
          <button class="action-btn" title="Send to Back" (click)="sendToBack()">
            <mat-icon>flip_to_back</mat-icon>
          </button>
          <button class="action-btn" title="Duplicate" (click)="duplicateElement(selectedElement)">
            <mat-icon>content_copy</mat-icon>
          </button>
          <button class="action-btn" title="Reset Transform" (click)="resetElementTransform()">
            <mat-icon>refresh</mat-icon>
          </button>
          <button class="action-btn delete" title="Delete" (click)="deleteElement(selectedElement)">
            <mat-icon>delete_forever</mat-icon>
          </button>
        </div>
        
        <!-- Alignment Tools -->
        <div class="alignment-tools">
          <h4 class="tools-title">Alignment</h4>
          <div class="alignment-grid">
            <button class="align-btn" (click)="alignElement('left')" title="Align Left">
              <mat-icon>align_horizontal_left</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('center-horizontal')" title="Center Horizontal">
              <mat-icon>align_horizontal_center</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('right')" title="Align Right">
              <mat-icon>align_horizontal_right</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('top')" title="Align Top">
              <mat-icon>align_vertical_top</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('center-vertical')" title="Center Vertical">
              <mat-icon>align_vertical_center</mat-icon>
            </button>
            <button class="align-btn" (click)="alignElement('bottom')" title="Align Bottom">
              <mat-icon>align_vertical_bottom</mat-icon>
            </button>
          </div>
          
          <div class="distribution-tools" *ngIf="selectedElements.length > 2">
            <button class="distribute-btn" (click)="distributeElements('horizontal')" title="Distribute Horizontally">
              <mat-icon>align_horizontal_left</mat-icon>
              <span>Horizontal</span>
            </button>
            <button class="distribute-btn" (click)="distributeElements('vertical')" title="Distribute Vertically">
              <mat-icon>align_vertical_top</mat-icon>
              <span>Vertical</span>
            </button>
          </div>
        </div>
      
      <!-- Common properties -->
      <div class="property-group">
        <label>Position & Size</label>
        <div class="property-grid">
          <div class="property-control">
            <span>X</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].x" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>Y</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].y" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>W</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].width" (change)="updateElement()">
          </div>
          <div class="property-control">
            <span>H</span>
            <input type="number" [(ngModel)]="canvasElements[selectedElement].height" (change)="updateElement()">
          </div>
        </div>
      </div>
      
      <!-- Advanced Text Properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'text'" class="advanced-text-properties">
        <!-- Text Content & AI Tools -->
        <div class="property-group">
          <div class="content-header">
            <label>Text Content</label>
            <div class="ai-tools">
              <button class="ai-btn" (click)="openAIRewrite()" title="AI Rewrite">
                <mat-icon>auto_fix_high</mat-icon>
              </button>
              <button class="ai-btn" (click)="openTranslateText()" title="Translate">
                <mat-icon>translate</mat-icon>
              </button>
              <button class="ai-btn" (click)="startVoiceToText()" title="Voice to Text">
                <mat-icon>mic</mat-icon>
              </button>
            </div>
          </div>
          <div class="text-editor-container">
            <textarea [(ngModel)]="canvasElements[selectedElement].content" 
                      (change)="updateElement()" 
                      class="advanced-text-editor"
                      placeholder="Enter your text here..."></textarea>
            <div class="text-tools">
              <button class="tool-btn" (click)="checkAccessibility()" title="Accessibility Check">
                <mat-icon>accessibility</mat-icon>
              </button>
              <button class="tool-btn" (click)="addHyperlink()" title="Add Link">
                <mat-icon>link</mat-icon>
              </button>
              <span class="char-count">{{ (canvasElements[selectedElement].content || '').length }} chars</span>
            </div>
          </div>
        </div>

        <!-- Font Selection & Pairing -->
        <div class="property-group">
          <label>
            <mat-icon>font_download</mat-icon>
            Font & Typography
          </label>
          <div class="font-selection">
            <div class="current-font-display">
              <div class="font-preview" [ngStyle]="getCurrentFontStyle()">
                {{ canvasElements[selectedElement].fontFamily || 'Select Font' }}
              </div>
              <button class="browse-fonts-btn" (click)="openFontBrowser()">
                <mat-icon>library_books</mat-icon>
                Browse Fonts
              </button>
            </div>
            
            <!-- Quick Font Size & Weight -->
            <div class="font-quick-controls">
              <div class="size-control">
                <button class="size-btn" (click)="adjustFontSize(-2)">
                  <mat-icon>remove</mat-icon>
                </button>
                <input type="number" 
                       [(ngModel)]="canvasElements[selectedElement].fontSize" 
                       (change)="updateElement()" 
                       class="size-input"
                       min="8" max="200">
                <button class="size-btn" (click)="adjustFontSize(2)">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
              <div class="weight-controls">
                <button class="style-btn" 
                        [class.active]="canvasElements[selectedElement].fontWeight === 'bold'"
                        (click)="toggleTextStyle('fontWeight', 'bold')">
                  <mat-icon>format_bold</mat-icon>
                </button>
                <button class="style-btn" 
                        [class.active]="canvasElements[selectedElement].fontStyle === 'italic'"
                        (click)="toggleTextStyle('fontStyle', 'italic')">
                  <mat-icon>format_italic</mat-icon>
                </button>
                <button class="style-btn" 
                        [class.active]="canvasElements[selectedElement].textDecoration === 'underline'"
                        (click)="toggleTextStyle('textDecoration', 'underline')">
                  <mat-icon>format_underlined</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Color & Gradient Controls -->
        <div class="property-group">
          <label>
            <mat-icon>palette</mat-icon>
            Color & Style
          </label>
          <div class="color-controls">
            <div class="color-tabs">
              <button class="color-tab" 
                      [class.active]="activeColorTab === 'solid'"
                      (click)="activeColorTab = 'solid'">Solid</button>
              <button class="color-tab" 
                      [class.active]="activeColorTab === 'gradient'"
                      (click)="activeColorTab = 'gradient'">Gradient</button>
            </div>
            
            <div class="color-content" *ngIf="activeColorTab === 'solid'">
              <div class="color-picker-container">
                <input type="color" 
                       [(ngModel)]="canvasElements[selectedElement].color" 
                       (change)="updateElement()" 
                       class="color-input">
                <div class="color-presets">
                  <div class="color-preset" 
                       *ngFor="let color of colorPresets" 
                       [style.background-color]="color"
                       (click)="applyColor(color)"
                       [class.selected]="canvasElements[selectedElement].color === color"></div>
                </div>
              </div>
            </div>
            
            <div class="color-content" *ngIf="activeColorTab === 'gradient'">
              <div class="gradient-controls">
                <div class="gradient-type">
                  <select [(ngModel)]="canvasElements[selectedElement].textGradientType" (change)="updateTextGradient()">
                    <option value="">No Gradient</option>
                    <option value="linear">Linear</option>
                    <option value="radial">Radial</option>
                  </select>
                </div>
                <div class="gradient-colors" *ngIf="canvasElements[selectedElement].textGradientType">
                  <input type="color" 
                         [(ngModel)]="canvasElements[selectedElement].textGradientColor1" 
                         (change)="updateTextGradient()" 
                         placeholder="Color 1">
                  <input type="color" 
                         [(ngModel)]="canvasElements[selectedElement].textGradientColor2" 
                         (change)="updateTextGradient()" 
                         placeholder="Color 2">
                </div>
                <div class="gradient-angle" *ngIf="canvasElements[selectedElement].textGradientType === 'linear'">
                  <label>Angle: {{ canvasElements[selectedElement].textGradientAngle || 0 }}°</label>
                  <input type="range" 
                         [(ngModel)]="canvasElements[selectedElement].textGradientAngle" 
                         (change)="updateTextGradient()" 
                         min="0" max="360" step="15">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Alignment & Positioning -->
        <div class="property-group">
          <label>
            <mat-icon>format_align_center</mat-icon>
            Alignment & Position
          </label>
          <div class="alignment-grid">
            <button class="align-btn" 
                    [class.active]="canvasElements[selectedElement].textAlign === 'left'"
                    (click)="setTextStyle('textAlign', 'left')" 
                    title="Align Left">
              <mat-icon>format_align_left</mat-icon>
            </button>
            <button class="align-btn" 
                    [class.active]="canvasElements[selectedElement].textAlign === 'center'"
                    (click)="setTextStyle('textAlign', 'center')" 
                    title="Align Center">
              <mat-icon>format_align_center</mat-icon>
            </button>
            <button class="align-btn" 
                    [class.active]="canvasElements[selectedElement].textAlign === 'right'"
                    (click)="setTextStyle('textAlign', 'right')" 
                    title="Align Right">
              <mat-icon>format_align_right</mat-icon>
            </button>
            <button class="align-btn" 
                    [class.active]="canvasElements[selectedElement].textAlign === 'justify'"
                    (click)="setTextStyle('textAlign', 'justify')" 
                    title="Justify">
              <mat-icon>format_align_justify</mat-icon>
            </button>
          </div>
          
          <div class="position-controls">
            <div class="transform-controls">
              <button class="transform-btn" (click)="rotateText(-90)" title="Rotate Left">
                <mat-icon>rotate_left</mat-icon>
              </button>
              <span class="rotation-display">{{ canvasElements[selectedElement].rotate || 0 }}°</span>
              <button class="transform-btn" (click)="rotateText(90)" title="Rotate Right">
                <mat-icon>rotate_right</mat-icon>
              </button>
            </div>
            <div class="flip-controls">
              <button class="transform-btn" (click)="flipText('horizontal')" title="Flip Horizontal">
                <mat-icon>flip</mat-icon>
              </button>
              <button class="transform-btn" (click)="flipText('vertical')" title="Flip Vertical">
                <mat-icon style="transform: rotate(90deg)">flip</mat-icon>
              </button>
            </div>
          </div>
        </div>
        <!-- Spacing & Typography Controls -->
        <div class="property-group">
          <label>
            <mat-icon>format_line_spacing</mat-icon>
            Spacing & Typography
          </label>
          <div class="spacing-controls">
            <div class="spacing-row">
              <div class="control-item">
                <label>Letter Spacing</label>
                <div class="control-input">
                  <input type="range" 
                         [(ngModel)]="canvasElements[selectedElement].letterSpacing" 
                         (change)="updateElement()" 
                         min="-5" max="20" step="0.1"
                         class="slider">
                  <span class="value">{{ canvasElements[selectedElement].letterSpacing || 0 }}px</span>
                </div>
              </div>
            </div>
            
            <div class="spacing-row">
              <div class="control-item">
                <label>Line Height</label>
                <div class="control-input">
                  <input type="range" 
                         [(ngModel)]="canvasElements[selectedElement].lineHeight" 
                         (change)="updateElement()" 
                         min="0.5" max="3" step="0.1"
                         class="slider">
                  <span class="value">{{ canvasElements[selectedElement].lineHeight || 1.2 }}</span>
                </div>
              </div>
            </div>
            
            <div class="spacing-row">
              <div class="control-item">
                <label>Character Spacing</label>
                <div class="control-input">
                  <input type="range" 
                         [(ngModel)]="canvasElements[selectedElement].wordSpacing" 
                         (change)="updateElement()" 
                         min="-10" max="50" step="1"
                         class="slider">
                  <span class="value">{{ canvasElements[selectedElement].wordSpacing || 0 }}px</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Auto-fit and Smart Sizing -->
          <div class="smart-controls">
            <button class="smart-btn" 
                    [class.active]="canvasElements[selectedElement].autoFit"
                    (click)="toggleAutoFit()" 
                    title="Auto-fit text size">
              <mat-icon>fit_screen</mat-icon>
              <span>Auto-fit</span>
            </button>
            <button class="smart-btn" 
                    [class.active]="canvasElements[selectedElement].textWrap"
                    (click)="toggleTextWrap()" 
                    title="Text wrapping">
              <mat-icon>wrap_text</mat-icon>
              <span>Wrap</span>
            </button>
          </div>
        </div>
        <!-- Advanced Text Effects -->
        <div class="property-group">
          <label>
            <mat-icon>auto_fix_high</mat-icon>
            Text Effects
          </label>
          <div class="effects-grid">
            <!-- Effect Presets -->
            <div class="effect-presets">
              <button class="preset-btn" 
                      *ngFor="let preset of textEffectPresets" 
                      (click)="applyTextEffectPreset(preset)"
                      [title]="preset.name">
                <div class="preset-preview" [ngStyle]="getEffectPreviewStyle(preset)">Aa</div>
                <span>{{ preset.name }}</span>
              </button>
            </div>
          </div>
          
          <!-- Effect Tabs -->
          <div class="effect-tabs">
            <button class="effect-tab" 
                    [class.active]="activeEffectTab === 'shadow'"
                    (click)="activeEffectTab = 'shadow'">Shadow</button>
            <button class="effect-tab" 
                    [class.active]="activeEffectTab === 'outline'"
                    (click)="activeEffectTab = 'outline'">Outline</button>
            <button class="effect-tab" 
                    [class.active]="activeEffectTab === 'highlight'"
                    (click)="activeEffectTab = 'highlight'">Highlight</button>
            <button class="effect-tab" 
                    [class.active]="activeEffectTab === 'curve'"
                    (click)="activeEffectTab = 'curve'">Curve</button>
          </div>
          
          <!-- Shadow Controls -->
          <div class="effect-panel" *ngIf="activeEffectTab === 'shadow'">
            <div class="effect-controls">
              <div class="control-row">
                <label>Shadow Type</label>
                <select [(ngModel)]="canvasElements[selectedElement].shadowType" (change)="updateTextShadow()">
                  <option value="none">None</option>
                  <option value="drop">Drop Shadow</option>
                  <option value="inner">Inner Shadow</option>
                  <option value="neon">Neon Glow</option>
                  <option value="multiple">Multiple Shadows</option>
                </select>
              </div>
              <div class="control-row" *ngIf="canvasElements[selectedElement].shadowType !== 'none'">
                <label>Shadow Color</label>
                <input type="color" 
                       [(ngModel)]="canvasElements[selectedElement].shadowColor" 
                       (change)="updateTextShadow()">
              </div>
              <div class="control-row" *ngIf="canvasElements[selectedElement].shadowType !== 'none'">
                <label>Blur: {{ canvasElements[selectedElement].shadowBlur || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].shadowBlur" 
                       (change)="updateTextShadow()" 
                       min="0" max="50" step="1">
              </div>
              <div class="control-row" *ngIf="canvasElements[selectedElement].shadowType !== 'none'">
                <label>Offset X: {{ canvasElements[selectedElement].shadowOffsetX || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].shadowOffsetX" 
                       (change)="updateTextShadow()" 
                       min="-50" max="50" step="1">
              </div>
              <div class="control-row" *ngIf="canvasElements[selectedElement].shadowType !== 'none'">
                <label>Offset Y: {{ canvasElements[selectedElement].shadowOffsetY || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].shadowOffsetY" 
                       (change)="updateTextShadow()" 
                       min="-50" max="50" step="1">
              </div>
            </div>
          </div>
          
          <!-- Outline Controls -->
          <div class="effect-panel" *ngIf="activeEffectTab === 'outline'">
            <div class="effect-controls">
              <div class="control-row">
                <label>Outline Width: {{ canvasElements[selectedElement].outlineWidth || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].outlineWidth" 
                       (change)="updateTextOutline()" 
                       min="0" max="10" step="0.5">
              </div>
              <div class="control-row">
                <label>Outline Color</label>
                <input type="color" 
                       [(ngModel)]="canvasElements[selectedElement].outlineColor" 
                       (change)="updateTextOutline()">
              </div>
            </div>
          </div>
          
          <!-- Highlight Controls -->
          <div class="effect-panel" *ngIf="activeEffectTab === 'highlight'">
            <div class="effect-controls">
              <div class="control-row">
                <label>Background Color</label>
                <input type="color" 
                       [(ngModel)]="canvasElements[selectedElement].backgroundColor" 
                       (change)="updateElement()">
              </div>
              <div class="control-row">
                <label>Padding: {{ canvasElements[selectedElement].padding || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].padding" 
                       (change)="updateElement()" 
                       min="0" max="50" step="1">
              </div>
              <div class="control-row">
                <label>Border Radius: {{ canvasElements[selectedElement].borderRadius || 0 }}px</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].borderRadius" 
                       (change)="updateElement()" 
                       min="0" max="50" step="1">
              </div>
            </div>
          </div>
          
          <!-- Curved Text Controls -->
          <div class="effect-panel" *ngIf="activeEffectTab === 'curve'">
            <div class="effect-controls">
              <div class="control-row">
                <label>Curve Type</label>
                <select [(ngModel)]="canvasElements[selectedElement].curveType" (change)="updateTextCurve()">
                  <option value="none">None</option>
                  <option value="arc">Arc</option>
                  <option value="bridge">Bridge</option>
                  <option value="bulge">Bulge</option>
                  <option value="wave">Wave</option>
                  <option value="circle">Circle</option>
                </select>
              </div>
              <div class="control-row" *ngIf="canvasElements[selectedElement].curveType !== 'none'">
                <label>Curve Amount: {{ canvasElements[selectedElement].curveAmount || 0 }}%</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].curveAmount" 
                       (change)="updateTextCurve()" 
                       min="-100" max="100" step="5">
              </div>
            </div>
          </div>
        </div>
        <!-- Text Animations -->
        <div class="property-group">
          <label>
            <mat-icon>animation</mat-icon>
            Text Animations
          </label>
          <div class="animation-controls">
            <div class="animation-presets">
              <button class="animation-btn" 
                      *ngFor="let animation of textAnimations" 
                      (click)="applyTextAnimation(animation)"
                      [class.active]="canvasElements[selectedElement].animation === animation.type"
                      [title]="animation.name">
                <mat-icon>{{ animation.icon }}</mat-icon>
                <span>{{ animation.name }}</span>
              </button>
            </div>
            
            <div class="animation-settings" *ngIf="canvasElements[selectedElement].animation">
              <div class="control-row">
                <label>Duration: {{ canvasElements[selectedElement].animationDuration || 1 }}s</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].animationDuration" 
                       (change)="updateAnimation()" 
                       min="0.1" max="5" step="0.1">
              </div>
              <div class="control-row">
                <label>Delay: {{ canvasElements[selectedElement].animationDelay || 0 }}s</label>
                <input type="range" 
                       [(ngModel)]="canvasElements[selectedElement].animationDelay" 
                       (change)="updateAnimation()" 
                       min="0" max="3" step="0.1">
              </div>
              <div class="control-row">
                <label>Loop</label>
                <input type="checkbox" 
                       [(ngModel)]="canvasElements[selectedElement].animationLoop" 
                       (change)="updateAnimation()">
              </div>
            </div>
            
            <button class="preview-animation-btn" 
                    (click)="previewAnimation()" 
                    *ngIf="canvasElements[selectedElement].animation">
              <mat-icon>play_arrow</mat-icon>
              Preview Animation
            </button>
          </div>
        </div>

        <!-- Transparency & Opacity -->
        <div class="property-group">
          <label>
            <mat-icon>opacity</mat-icon>
            Transparency & Masking
          </label>
          <div class="transparency-controls">
            <div class="control-row">
              <label>Opacity: {{ getOpacityPercentage() }}%</label>
              <input type="range" 
                     [(ngModel)]="canvasElements[selectedElement].opacity" 
                     (change)="updateElement()" 
                     min="0" max="1" step="0.01"
                     class="slider">
            </div>
            
            <div class="masking-options">
              <button class="mask-btn" 
                      (click)="enableTextMasking()" 
                      [class.active]="canvasElements[selectedElement].maskEnabled"
                      title="Use text as mask for images">
                <mat-icon>layers</mat-icon>
                <span>Text as Mask</span>
              </button>
              <button class="mask-btn" 
                      (click)="addTextToFrame()" 
                      title="Add text to image frame">
                <mat-icon>crop_free</mat-icon>
                <span>Text in Frame</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Brand Kit & Accessibility -->
        <div class="property-group">
          <label>
            <mat-icon>branding_watermark</mat-icon>
            Brand Kit & Accessibility
          </label>
          <div class="brand-accessibility">
            <div class="brand-controls">
              <button class="brand-btn" (click)="applyBrandFont()" title="Apply brand font">
                <mat-icon>business</mat-icon>
                <span>Brand Font</span>
              </button>
              <button class="brand-btn" (click)="saveToBrandKit()" title="Save to brand kit">
                <mat-icon>bookmark_add</mat-icon>
                <span>Save Style</span>
              </button>
            </div>
            
            <div class="accessibility-checker">
              <button class="accessibility-btn" 
                      (click)="checkContrastRatio()" 
                      [class.warning]="contrastRatio < 4.5"
                      [class.good]="contrastRatio >= 4.5">
                <mat-icon>accessibility</mat-icon>
                <span>Contrast: {{ contrastRatio ? contrastRatio.toFixed(1) : 'Check' }}</span>
              </button>
              <div class="accessibility-info" *ngIf="contrastRatio">
                <span class="status" [class.pass]="contrastRatio >= 4.5" [class.fail]="contrastRatio < 4.5">
                  {{ contrastRatio >= 4.5 ? 'WCAG AA ✓' : 'WCAG AA ✗' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="property-group">
          <label>Legacy Text Effects</label>
          <div class="text-effects-tabs">
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'stroke'}" (click)="activeTextEffectTab = 'stroke'">Stroke</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'shadow'}" (click)="activeTextEffectTab = 'shadow'">Shadow</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'gradient'}" (click)="activeTextEffectTab = 'gradient'">Gradient</button>
            <button class="effect-tab" [ngClass]="{'active': activeTextEffectTab === 'highlight'}" (click)="activeTextEffectTab = 'highlight'">Highlight</button>
          </div>
          
          <!-- Stroke Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'stroke'">
            <div class="property-controls">
              <div class="property-control">
                <span>Stroke Width: {{canvasElements[selectedElement].textStrokeWidth || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].textStrokeWidth" 
                       (change)="updateElement()" min="0" max="5" step="0.5">
              </div>
              <div class="property-control">
                <span>Stroke Color</span>
                <input type="color" [(ngModel)]="canvasElements[selectedElement].textStrokeColor" (change)="updateElement()">
              </div>
            </div>
          </div>
          
          <!-- Shadow Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'shadow'">
            <div class="property-controls">
              <div class="property-control">
                <span>Shadow Preset</span>
                <select [(ngModel)]="canvasElements[selectedElement].textShadow" (change)="updateElement()">
                  <option value="none">None</option>
                  <option value="1px 1px 2px rgba(0,0,0,0.3)">Light</option>
                  <option value="2px 2px 4px rgba(0,0,0,0.4)">Medium</option>
                  <option value="3px 3px 5px rgba(0,0,0,0.5)">Heavy</option>
                  <option value="0px 0px 8px rgba(0,0,255,0.7)">Neon Blue</option>
                  <option value="0px 0px 8px rgba(255,0,0,0.7)">Neon Red</option>
                  <option value="0px 0px 3px white, 0px 0px 5px rgba(0,0,0,0.5)">Outline</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              
              <div class="custom-shadow-controls" *ngIf="canvasElements[selectedElement].textShadow === 'custom'">
                <div class="property-control">
                  <span>Shadow Color</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].customShadowColor" (change)="updateCustomTextShadow()">
                </div>
                <div class="property-control">
                  <span>Blur: {{canvasElements[selectedElement].customShadowBlur || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowBlur" 
                         (change)="updateCustomTextShadow()" min="0" max="20" step="1">
                </div>
                <div class="property-control">
                  <span>Offset X: {{canvasElements[selectedElement].customShadowX || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowX" 
                         (change)="updateCustomTextShadow()" min="-20" max="20" step="1">
                </div>
                <div class="property-control">
                  <span>Offset Y: {{canvasElements[selectedElement].customShadowY || 0}}px</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].customShadowY" 
                         (change)="updateCustomTextShadow()" min="-20" max="20" step="1">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Gradient Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'gradient'">
            <div class="property-controls">
              <div class="property-control">
                <span>Gradient Type</span>
                <select [(ngModel)]="canvasElements[selectedElement].textGradientType" (change)="updateTextGradient()">
                  <option value="none">None</option>
                  <option value="linear">Linear</option>
                  <option value="radial">Radial</option>
                </select>
              </div>
              
              <div class="gradient-controls" *ngIf="canvasElements[selectedElement].textGradientType !== 'none'">
                <div class="property-control">
                  <span>Color 1</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].textGradientColor1" (change)="updateTextGradient()">
                </div>
                <div class="property-control">
                  <span>Color 2</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].textGradientColor2" (change)="updateTextGradient()">
                </div>
                <div class="property-control" *ngIf="canvasElements[selectedElement].textGradientType === 'linear'">
                  <span>Angle: {{canvasElements[selectedElement].textGradientAngle || 45}}°</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].textGradientAngle" 
                         (change)="updateTextGradient()" min="0" max="360" step="15">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Highlight Tab -->
          <div class="effect-content" *ngIf="activeTextEffectTab === 'highlight'">
            <div class="property-controls">
              <div class="property-control">
                <span>Highlight Style</span>
                <select [(ngModel)]="canvasElements[selectedElement].highlightStyle" (change)="updateElement()">
                  <option value="none">None</option>
                  <option value="solid">Solid Background</option>
                  <option value="marker">Marker Highlight</option>
                  <option value="underline">Underline</option>
                  <option value="box">Box Highlight</option>
                </select>
              </div>
              
              <div class="highlight-controls" *ngIf="canvasElements[selectedElement].highlightStyle !== 'none'">
                <div class="property-control">
                  <span>Highlight Color</span>
                  <input type="color" [(ngModel)]="canvasElements[selectedElement].highlightColor" (change)="updateElement()">
                </div>
                <div class="property-control">
                  <span>Opacity: {{canvasElements[selectedElement].highlightOpacity || 0.3}}</span>
                  <input type="range" [(ngModel)]="canvasElements[selectedElement].highlightOpacity" 
                         (change)="updateElement()" min="0.1" max="1" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Text Transform</label>
          <div class="text-transform-controls">
            <div class="transform-actions">
              <button class="transform-btn" (click)="rotateText(-90)" title="Rotate Left">
                <mat-icon>rotate_left</mat-icon>
              </button>
              <button class="transform-btn" (click)="rotateText(90)" title="Rotate Right">
                <mat-icon>rotate_right</mat-icon>
              </button>
              <button class="transform-btn" (click)="flipText('horizontal')" title="Flip Horizontal">
                <mat-icon>flip</mat-icon>
              </button>
              <button class="transform-btn" (click)="flipText('vertical')" title="Flip Vertical">
                <mat-icon>flip</mat-icon>
              </button>
            </div>
            
            <div class="property-control">
              <span>Rotation: {{canvasElements[selectedElement].textRotation || 0}}°</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].textRotation" 
                     (change)="updateElement()" min="-180" max="180" step="5">
            </div>
            
            <div class="property-control">
              <span>Text Path</span>
              <select [(ngModel)]="canvasElements[selectedElement].textPath" (change)="updateElement()">
                <option value="none">None</option>
                <option value="arc">Arc</option>
                <option value="circle">Circle</option>
                <option value="wave">Wave</option>
              </select>
            </div>
            
            <div class="path-controls" *ngIf="canvasElements[selectedElement].textPath !== 'none'">
              <div class="property-control">
                <span>Path Strength: {{canvasElements[selectedElement].textPathStrength || 50}}</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].textPathStrength" 
                       (change)="updateElement()" min="0" max="100" step="5">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Image specific properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'image'">
        <div class="property-group">
          <label>Image</label>
          <div class="image-preview">
            <img [src]="canvasElements[selectedElement].src" [alt]="canvasElements[selectedElement].alt || 'Image'">
          </div>
          <button class="replace-image-btn" (click)="triggerUpload()">
            <mat-icon>photo_library</mat-icon>
            <span>Replace Image</span>
          </button>
        </div>
        
        <div class="property-group">
          <label>Image Appearance</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Object Fit</span>
              <select [(ngModel)]="canvasElements[selectedElement].objectFit" (change)="updateElement()">
                <option value="contain">Contain</option>
                <option value="cover">Cover</option>
                <option value="fill">Fill</option>
                <option value="scale-down">Scale Down</option>
              </select>
            </div>
            <div class="property-control">
              <span>Border Radius</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].borderRadius" (change)="updateElement()" min="0" max="100">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Transform</label>
          <div class="image-transform-grid">
            <button class="image-edit-btn" (click)="cropImage()">
              <mat-icon>crop</mat-icon>
              <span>Crop</span>
            </button>
            <button class="image-edit-btn" (click)="scaleImage()">
              <mat-icon>transform</mat-icon>
              <span>Scale</span>
            </button>
            <button class="image-edit-btn" (click)="rotateImage(-90)">
              <mat-icon>rotate_left</mat-icon>
              <span>Rotate Left</span>
            </button>
            <button class="image-edit-btn" (click)="rotateImage(90)">
              <mat-icon>rotate_right</mat-icon>
              <span>Rotate Right</span>
            </button>
            <button class="image-edit-btn" (click)="flipImage('horizontal')">
              <mat-icon>flip</mat-icon>
              <span>Flip H</span>
            </button>
            <button class="image-edit-btn" (click)="flipImage('vertical')">
              <mat-icon>flip</mat-icon>
              <span>Flip V</span>
            </button>
          </div>
          
          <div class="aspect-ratio-controls">
            <label>
              <input type="checkbox" [(ngModel)]="canvasElements[selectedElement].lockAspectRatio" (change)="updateElement()">
              Lock Aspect Ratio
            </label>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Filters</label>
          <div class="filter-tabs">
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'basic'}" (click)="activeImageFilterTab = 'basic'">Basic</button>
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'advanced'}" (click)="activeImageFilterTab = 'advanced'">Advanced</button>
            <button class="filter-tab" [ngClass]="{'active': activeImageFilterTab === 'blend'}" (click)="activeImageFilterTab = 'blend'">Blend</button>
          </div>
          
          <!-- Basic Filters -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'basic'">
            <div class="filter-sliders">
              <div class="filter-control">
                <span>Brightness: {{canvasElements[selectedElement].brightness || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].brightness" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Contrast: {{canvasElements[selectedElement].contrast || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].contrast" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Saturation: {{canvasElements[selectedElement].saturation || 100}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].saturation" 
                       (change)="updateImageFilters()" min="0" max="200" step="5" value="100">
              </div>
              <div class="filter-control">
                <span>Hue Rotate: {{canvasElements[selectedElement].hueRotate || 0}}°</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].hueRotate" 
                       (change)="updateImageFilters()" min="0" max="360" step="15" value="0">
              </div>
            </div>
          </div>
          
          <!-- Advanced Filters -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'advanced'">
            <div class="filter-sliders">
              <div class="filter-control">
                <span>Blur: {{canvasElements[selectedElement].blur || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].blur" 
                       (change)="updateImageFilters()" min="0" max="10" step="0.5" value="0">
              </div>
              <div class="filter-control">
                <span>Sepia: {{canvasElements[selectedElement].sepia || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].sepia" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
              <div class="filter-control">
                <span>Grayscale: {{canvasElements[selectedElement].grayscale || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].grayscale" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
              <div class="filter-control">
                <span>Invert: {{canvasElements[selectedElement].invert || 0}}%</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].invert" 
                       (change)="updateImageFilters()" min="0" max="100" step="5" value="0">
              </div>
            </div>
          </div>
          
          <!-- Blend Modes -->
          <div class="filter-content" *ngIf="activeImageFilterTab === 'blend'">
            <div class="blend-controls">
              <div class="property-control">
                <span>Blend Mode</span>
                <select [(ngModel)]="canvasElements[selectedElement].blendMode" (change)="updateElement()">
                  <option value="normal">Normal</option>
                  <option value="multiply">Multiply</option>
                  <option value="screen">Screen</option>
                  <option value="overlay">Overlay</option>
                  <option value="soft-light">Soft Light</option>
                  <option value="hard-light">Hard Light</option>
                  <option value="color-dodge">Color Dodge</option>
                  <option value="color-burn">Color Burn</option>
                  <option value="darken">Darken</option>
                  <option value="lighten">Lighten</option>
                  <option value="difference">Difference</option>
                  <option value="exclusion">Exclusion</option>
                  <option value="luminosity">Luminosity</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="filter-presets">
            <button class="preset-filter-btn" (click)="applyFilterPreset('none')">Reset</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('vintage')">Vintage</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('blackwhite')">B&W</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('warm')">Warm</button>
            <button class="preset-filter-btn" (click)="applyFilterPreset('cool')">Cool</button>
          </div>
        </div>
        
        <div class="property-group">
          <label>Image Masking</label>
          <div class="masking-controls">
            <div class="mask-options">
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'rectangle'}"
                      (click)="applyMask('rectangle')">
                <mat-icon>crop_square</mat-icon>
                <span>Rectangle</span>
              </button>
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'circle'}"
                      (click)="applyMask('circle')">
                <mat-icon>radio_button_unchecked</mat-icon>
                <span>Circle</span>
              </button>
              <button class="mask-btn" [ngClass]="{'active': canvasElements[selectedElement].maskType === 'custom'}"
                      (click)="applyMask('custom')">
                <mat-icon>gesture</mat-icon>
                <span>Custom</span>
              </button>
              <button class="mask-btn" (click)="removeMask()">
                <mat-icon>clear</mat-icon>
                <span>Remove</span>
              </button>
            </div>
            
            <div class="mask-properties" *ngIf="canvasElements[selectedElement].maskType">
              <div class="property-control">
                <span>Feather: {{canvasElements[selectedElement].maskFeather || 0}}px</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].maskFeather" 
                       (change)="updateElement()" min="0" max="20" step="1">
              </div>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>PNG Transparency & Background Removal</label>
          <div class="transparency-controls">
            <button class="image-edit-btn" (click)="toggleBackgroundRemoval()" 
                    [ngClass]="{'active': isBackgroundRemovalActive()}">
              <mat-icon>content_cut</mat-icon>
              <span>Remove Background</span>
            </button>
            <button class="image-edit-btn" (click)="preserveTransparency()"
                    [ngClass]="{'active': canvasElements[selectedElement].preserveTransparency}">
              <mat-icon>transparency</mat-icon>
              <span>Preserve PNG Alpha</span>
            </button>
          </div>
        </div>
        
        <div class="property-group">
          <label>Effects</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Opacity</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].opacity" (change)="updateElement()" min="0.1" max="1" step="0.1">
              <span class="value-display">{{ canvasElements[selectedElement].opacity || 1 }}</span>
            </div>
            
            <div class="property-control">
              <span>Shadow</span>
              <select [(ngModel)]="canvasElements[selectedElement].boxShadow" (change)="updateElement()">
                <option value="none">None</option>
                <option value="0 2px 5px rgba(0,0,0,0.1)">Light</option>
                <option value="0 4px 8px rgba(0,0,0,0.2)">Medium</option>
                <option value="0 8px 16px rgba(0,0,0,0.3)">Strong</option>
              </select>
            </div>
            
            <div class="property-control">
              <span>Filter</span>
              <select [(ngModel)]="canvasElements[selectedElement].filter" (change)="updateElement()">
                <option value="none">None</option>
                <option value="grayscale(100%)">Grayscale</option>
                <option value="sepia(100%)">Sepia</option>
                <option value="blur(2px)">Blur</option>
                <option value="brightness(150%)">Brighten</option>
                <option value="contrast(150%)">Contrast</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Border</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Border Style</span>
              <select [(ngModel)]="canvasElements[selectedElement].border" (change)="updateElement()">
                <option value="none">None</option>
                <option value="1px solid #000">Thin</option>
                <option value="2px solid #000">Medium</option>
                <option value="3px solid #000">Thick</option>
                <option value="1px dashed #000">Dashed</option>
                <option value="1px dotted #000">Dotted</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Shape specific properties -->
      <div *ngIf="canvasElements[selectedElement].type === 'shape'">
        <div class="property-group">
          <label>Shape Type</label>
          <div class="shape-controls">
            <div class="shape-selector">
              <span>Type</span>
              <select [(ngModel)]="canvasElements[selectedElement].shape" (change)="updateElement()">
                <option value="rectangle">Rectangle</option>
                <option value="circle">Circle</option>
                <option value="triangle">Triangle</option>
                <option value="ellipse">Ellipse</option>
                <option value="diamond">Diamond</option>
                <option value="hexagon">Hexagon</option>
                <option value="star">Star</option>
                <option value="heart">Heart</option>
                <option value="arrow">Arrow</option>
              </select>
            </div>
            
            <div class="color-control">
              <span>Fill Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].color" (change)="updateElement()">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Gradient</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Gradient Type</span>
              <select [(ngModel)]="canvasElements[selectedElement].gradientType" (change)="updateGradient()">
                <option value="">No Gradient</option>
                <option value="linear">Linear</option>
                <option value="radial">Radial</option>
              </select>
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType">
              <span>First Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].gradientStop1" (change)="updateGradient()">
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType">
              <span>Second Color</span>
              <input type="color" [(ngModel)]="canvasElements[selectedElement].gradientStop2" (change)="updateGradient()">
            </div>
            
            <div class="property-control" *ngIf="canvasElements[selectedElement].gradientType === 'linear'">
              <span>Angle (°)</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].gradientAngle" (change)="updateGradient()" min="0" max="360" step="15">
              <span class="value-display">{{ canvasElements[selectedElement].gradientAngle || 0 }}°</span>
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Shape Properties</label>
          <div class="property-controls">
            <div class="property-control" *ngIf="canvasElements[selectedElement].shape === 'rectangle'">
              <span>Border Radius</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].borderRadius" (change)="updateElement()" min="0" max="100">
            </div>
            
            <div class="property-control">
              <span>Opacity</span>
              <input type="range" [(ngModel)]="canvasElements[selectedElement].opacity" (change)="updateElement()" min="0.1" max="1" step="0.1">
              <span class="value-display">{{ canvasElements[selectedElement].opacity || 1 }}</span>
            </div>
            
            <div class="property-control">
              <span>Rotation (°)</span>
              <input type="number" [(ngModel)]="canvasElements[selectedElement].rotate" (change)="updateElement()" min="0" max="360">
            </div>
          </div>
        </div>
        
        <div class="property-group">
          <label>Border & Effects</label>
          <div class="property-controls">
            <div class="property-control">
              <span>Border</span>
              <select [(ngModel)]="canvasElements[selectedElement].border" (change)="updateElement()">
                <option value="none">None</option>
                <option value="1px solid #000">Thin</option>
                <option value="2px solid #000">Medium</option>
                <option value="3px solid #000">Thick</option>
                <option value="1px dashed #000">Dashed</option>
                <option value="1px dotted #000">Dotted</option>
              </select>
            </div>
            
            <div class="property-control">
              <span>Shadow</span>
              <select [(ngModel)]="canvasElements[selectedElement].boxShadow" (change)="updateElement()">
                <option value="none">None</option>
                <option value="0 2px 5px rgba(0,0,0,0.1)">Light</option>
                <option value="0 4px 8px rgba(0,0,0,0.2)">Medium</option>
                <option value="0 8px 16px rgba(0,0,0,0.3)">Strong</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            
            <div class="shadow-custom-controls" *ngIf="canvasElements[selectedElement].boxShadow === 'custom'">
              <div class="property-control">
                <span>Shadow Color</span>
                <input type="color" [(ngModel)]="canvasElements[selectedElement].shadowColor" (change)="updateCustomShadow()">
              </div>
              <div class="property-control">
                <span>Blur</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowBlur" (change)="updateCustomShadow()" min="0" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowBlur || 0 }}px</span>
              </div>
              <div class="property-control">
                <span>Offset X</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowOffsetX" (change)="updateCustomShadow()" min="-20" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowOffsetX || 0 }}px</span>
              </div>
              <div class="property-control">
                <span>Offset Y</span>
                <input type="range" [(ngModel)]="canvasElements[selectedElement].shadowOffsetY" (change)="updateCustomShadow()" min="-20" max="20" step="1">
                <span class="value-display">{{ canvasElements[selectedElement].shadowOffsetY || 0 }}px</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Custom Size Dialog -->
  <div class="dialog-overlay" *ngIf="showCustomSizeDialog">
    <div class="dialog-container">
      <div class="dialog-header">
        <h3>Custom Canvas Size</h3>
        <button class="close-btn" (click)="closeCustomSizeDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <div class="size-input-group">
          <div class="size-input">
            <label for="customWidth">Width (px)</label>
            <input type="number" id="customWidth" [(ngModel)]="customWidth" min="50" max="2000">
          </div>
          <div class="size-input">
            <label for="customHeight">Height (px)</label>
            <input type="number" id="customHeight" [(ngModel)]="customHeight" min="50" max="2000">
          </div>
        </div>
        <div class="preset-sizes">
          <h4>Preset Sizes</h4>
          <div class="preset-buttons">
            <button (click)="selectPresetSize('instagram')">Instagram Post</button>
            <button (click)="selectPresetSize('facebook')">Facebook Post</button>
            <button (click)="selectPresetSize('twitter')">Twitter Post</button>
            <button (click)="selectPresetSize('story')">Instagram Story</button>
            <button (click)="selectPresetSize('youtube')">YouTube Thumbnail</button>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeCustomSizeDialog()">Cancel</button>
        <button class="apply-btn" (click)="applyCustomSize()">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Image Crop Dialog -->
  <div class="dialog-overlay" *ngIf="showCropDialog">
    <div class="dialog-container crop-dialog">
      <div class="dialog-header">
        <h3>Crop Image</h3>
        <button class="close-btn" (click)="closeCropDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <div class="crop-container">
          <img #cropImage [src]="currentImageToCrop?.src" alt="Image to crop">
          <div class="crop-area" #cropArea
               [style.width.px]="cropWidth"
               [style.height.px]="cropHeight"
               [style.top.px]="cropTop"
               [style.left.px]="cropLeft"
               (mousedown)="startCropDrag($event)">
            <div class="resize-handle top-left" (mousedown)="startCropResize('top-left', $event)"></div>
            <div class="resize-handle top-right" (mousedown)="startCropResize('top-right', $event)"></div>
            <div class="resize-handle bottom-left" (mousedown)="startCropResize('bottom-left', $event)"></div>
            <div class="resize-handle bottom-right" (mousedown)="startCropResize('bottom-right', $event)"></div>
          </div>
        </div>
        <div class="crop-controls">
          <div class="crop-aspect-ratio">
            <span>Aspect Ratio:</span>
            <select [(ngModel)]="cropAspectRatio" (change)="applyCropAspectRatio()">
              <option value="free">🆓 Free Form</option>
              <option value="1:1">⬜ 1:1 (Square)</option>
              <option value="4:3">📺 4:3 (Standard)</option>
              <option value="16:9">📱 16:9 (Widescreen)</option>
              <option value="3:4">📄 3:4 (Portrait)</option>
              <option value="9:16">📱 9:16 (Mobile)</option>
            </select>
          </div>
          <div class="crop-dimensions">
            <span>Crop Size: {{cropWidth}} × {{cropHeight}} px</span>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeCropDialog()">Cancel</button>
        <button class="apply-btn" (click)="applyCrop()">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Share Link Dialog -->
  <div class="dialog-overlay" *ngIf="showShareDialog">
    <div class="dialog-container share-dialog">
      <div class="dialog-header">
        <h3>Share Template</h3>
        <button class="close-btn" (click)="closeShareDialog()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="dialog-content">
        <p>Share this link with others to let them view or edit this template:</p>
        <div class="share-link">
          <input type="text" [value]="shareLink" readonly #shareLinkInput>
          <button (click)="copyShareLink(shareLinkInput)">
            <mat-icon>content_copy</mat-icon>
          </button>
        </div>
        <div class="share-permissions">
          <h4>Permissions</h4>
          <div class="permission-option">
            <input type="radio" id="view-only" name="permission" value="view" [(ngModel)]="sharePermission">
            <label for="view-only">View only</label>
          </div>
          <div class="permission-option">
            <input type="radio" id="can-edit" name="permission" value="edit" [(ngModel)]="sharePermission">
            <label for="can-edit">Can edit</label>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <button class="cancel-btn" (click)="closeShareDialog()">Close</button>
        <button class="apply-btn" (click)="generateNewShareLink()">Generate New Link</button>
      </div>
    </div>
  </div>
</div>
